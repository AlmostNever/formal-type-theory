
\section{Translation}
\label{sec:translation}

We need the following translations:
%
\begin{align}
  \label{lbl:ctx-ctr}
  \isctx{\G}
  &\quad\leadsto\quad
  \isctx{\G'}
  \\
  \label{lbl:ty-ctr}
  \G', (\istype{\G}{\A})
  &\quad\leadsto\quad
  \istype{\G'}{\A'}
  \\
  \label{lbl:ty-path}
  % the following is needed if we ever need to construct an equivalence given A',B' and A \equiv B
  (\istype{\G'}{\A'}), (\istype{\G}{\A})
  &\quad\leadsto\quad
  (\istype{\G'}{\A''}), (\G' \vdash \A' \simeq \A'')
  \\
  \label{lbl:term-ctr}
  (\G', A'), (\isterm{\G}{\uu}{\A})
  &\quad\leadsto\quad
  \isterm{\G'}{\uu'}{\A'}
  \\
  % the following is needed if we ever need to construct an equivalence given u', v' and u \equiv v
  % (which happens if we need to construct an equivalence given A',B' and A \equiv B)
  \label{lbl:term-path}
  (\isterm{\G'}{\uu'}{\A'}), (\isterm{\G}{\uu}{\A})
  &\quad\leadsto\quad
  (\isterm{\G'}{\uu''}{\A'}), (\G' \vdash \uu' \simeq \uu'' : \A')
  \\
  \G', (\issubst{\sbs}{\G}{\D})
  &\quad\leadsto\quad
  \issubst{\sbs'}{\G'}{\D'}
  \\
  (\issubst{\sbs'}{\G'}{\D'}), (\issubst{\sbs}{\G}{\D})
  &\quad\leadsto\quad
  (\issubst{\sbs''}{\G'}{\D''}), (\sbs' \simeq \sbs'')
  \\
  \label{lbl:eq-ctx-path}
  \G', (\eqctx{\G}{\D})
  &\quad\leadsto\quad
  (\isctx{\D'}), (\G' \simeq \D')
  \\
  \label{lbl:eq-ty-path}
  \G', \B', (\eqtype{\G}{\A}{\B})
  &\quad\leadsto\quad
  (\istype{\G'}{\A'}), (\G' \vdash \A' \simeq \B')
  \\
  \label{lbl:eq-term-path}
  \G', \A', \vv', (\eqterm{\G}{\uu}{\vv}{\A})
  &\quad\leadsto\quad
  (\isterm{\G'}{\A'}{\uu'}), (\G' \vdash \uu' \simeq \vv' : \A')
\end{align}
%
Remarks:
%
\begin{itemize}
\item \eqref{lbl:ty-path} must give the same result as~\eqref{lbl:eq-ty-path} applied to
  the reflexivity case. This is so that we can use the result of~\eqref{lbl:eq-ty-path} as
  if it were obtained through conversion.
\item \eqref{lbl:term-path} must give the same result as~\eqref{lbl:eq-term-path} applied
  to the reflexivity case, for similar reasons.
\item We will need to know that all the equivalences generated from the derivations of a
  given equation are equal (propositionally pointwise). This is where UIP will come into
  play, since such equivalences are compositions of structural acrobatics and transports
  along paths used in $\rl{eq-reflection}$.
\item We also need to know that translations of contexts have the same shape
  as the original context, and the same goes for translation of types up
  to context isomorphisms.
\item In the rules producing isomorphims, we actually assume that the center
  generated is the same as the one that would be generated by the corresponding
  ``simple'' rule.
\end{itemize}


\subsection{Proof of the translation}
\label{sec:proof-tran}

\Case{ctx-empty}
%
The derivation
%
\begin{equation*}
  \infer{ }{\isctx{\ctxempty}}
\end{equation*}
%
is translated into
%
\begin{equation*}
  \infer{ }{\isctx{\ctxempty}}
\end{equation*}


\Case{ctx-extend}

Consider the derivation
%
%
\begin{equation*}
  \infer{
    \inferrule*{\DD}{\isctx{\G}} \\
    \inferrule*{\EE}{\istype{\G}{\A}} \\
    x \not\in \ctxdom{\G}
  }
  {\isctx{(\ctxextend{\G}{\x}{\A})}}
\end{equation*}
%
By~\eqref{lbl:ctx-ctr} on $\derives{\DD}{\isctx{\G}}$, we get
$\derives{\DD'}{\isctx{\G'}}$.
By~\eqref{lbl:ty-ctr} on $\derives{\EE}{\istype{\G}{\A}}$ and $\G'$, we get
$\derives{\EE'}{\istype{\G'}{\A'}}$.
Since $\ctxdom{\G} = \ctxdom{\G'}$, we have $x \notin \ctxdom{\G'}$ and thus
%
\begin{equation*}
  \infer{
    \inferrule*{\DD'}{\isctx{\G'}} \\
    \inferrule*{\EE'}{\istype{\G'}{\A'}} \\
    x \not\in \ctxdom{\G'}
  }
  {\isctx{(\ctxextend{\G'}{\x}{\A'})}}
\end{equation*}


\Case{ty-ctx-conv}

Consider the derivation
%
%
\begin{equation*}
  \infer{
    \inferrule*{\DD}{\istype{\G}{\A}} \\
    \inferrule*{\EE}{\eqctx{\G}{\D}}
  }
  {\istype{\D}{\A}}
\end{equation*}
%
We need to prove~\eqref{lbl:ty-ctr} and~\eqref{lbl:ty-path}.
First assume we have $\D'$ a translation of $\D$.
From $\derives{\EE}{\eqctx{\G}{\D}}$ and $\D'$, we
apply~\eqref{lbl:eq-ctx-path} (\meta{in the symmetric version}) and we deduce
$\G'$ a translation of $\G$ such that $\G' \simeq \D'$ (meaning that in
particular we have some morphism $f$ from $\G'$ to $\D'$).
From $\G'$ and $\derives{\DD}{\istype{\G}{\A}}$, we apply~\eqref{lbl:ty-ctr}
to get $\derives{\DD'}{\istype{\G'}{\A'}}$.
We can finally build the translation:
%
\begin{equation*}
  \infer{
    \inferrule*{\DD'}{\istype{\G'}{\A'}} \\
    \issubst{\f}{\D'}{\G'}
  }
  {\istype{\D'}{\subst{\A'}{f}}}
\end{equation*}
%
\meta{We need to specify who is $\f$ (and its derivation) and how it applies.}

Now, let's extend our proof to match~\eqref{lbl:ty-path}.
Assume we are given $\istype{\D'}{\A''}$, let's build an equivalence
$\D' \vdash \subst{\A'}{\f} \simeq \A''$.
Since $\G' \simeq \D'$, we have an inverse to $\f$, say $\g$.
For this we deduce $\istype{\G'}{\subst{\A''}{\g}}$.
Using this, together with $\istype{\G'}{\A'}$, we can apply~\eqref{lbl:ty-path}
to get some isomorphism $\G' \vdash \A' \simeq \subst{\A''}{\g}$.
From this we can build an isomorphism
$\D' \vdash \subst{\A'}{\f} \simeq \subst{\subst{\A''}{\g}}{\f}$.
But as we said, $\g$ and $\f$ are inverses, so
$\D' \vdash \subst{\subst{\A''}{\g}}{\f} \simeq \A''$, hence
$\D' \vdash \subst{\A'}{\f} \simeq \A''$.

\Case{ty-subst}
\meta{TODO}

\Case{ty-prod}

Consider
%
\begin{equation*}
  \infer{
    \inferrule*{\DD}{\istype{\G}{\A}} \\
    \inferrule*{\EE}{\istype{\ctxextend{\G}{\x}{\A}}{\B}}
  }
  {\istype{\G}{\Prod{\x}{\A}{\B}}}
\end{equation*}
%
We prove~\eqref{lbl:ty-ctr} and then~\eqref{lbl:ty-path}.
Assume $\G'$, from~\eqref{lbl:ty-ctr}, we get $\istype{\G'}{\A'}$ and then
using $\ctxextend{\G'}{\x}{\A'}$
(well-formed since $x \notin \ctxdom{\G} = \ctxdom{\G'}$)
we get $\istype{\ctxextend{\G'}{\x}{\A'}}{\B'}$.
Finally we reconstruct $\istype{\G'}{\Prod{\x}{\A'}{\B'}}$.

Now, to prove~\eqref{lbl:ty-path}, assume $\istype{\G'}{\C''}$
is some translation of $\istype{\G}{\Prod{\x}{\A}{\B}}$.
If we invert on the translation, $\C''$ is actually an arbitrary number
(possibly zero) of context morphisms applied to a $\Pi$-type translation
$\istype{\G''}{\Prod{\x}{\A''}{\B''}}$.
To simplify matters, we assume we only have one such context morphism
$\G' \simeq \G''$ with $\issubst{\f}{\G''}{\G'}$ and $\issubst{\g}{\G'}{\G''}$
which is the composition of all the substitutions (in case we have none, this
would result in the identity morphism). It is indeed admissible as we can show
an equivalence between the two types (the one with one, and the one with an
arbitrary number of substitutions in its head).
By inversion, $\istype{\G''}{\A''}$, and thus $\istype{\G'}{\subst{\A''}{\g}}$
so by~\eqref{lbl:ty-path}, we have $\G' \vdash \subst{\A''}{\g} \simeq \A'$,
in particular, we can extend $\f$ and $\g$ into $\f'$ and $\g'$ to get an
isomorphism $\ctxextend{\G'}{\x}{\A'} \simeq \ctxextend{\G''}{\x}{\A''}$.
By inversion, we also have $\istype{\ctxextend{\G''}{\x}{\A''}}{\B''}$,
and thus $\istype{\ctxextend{\G'}{\x}{\A'}}{\subst{\B''}{\g'}}$,
so by~\eqref{lbl:ty-path}, we have
$\ctxextend{\G'}{\x}{\A'} \vdash \subst{\B''}{\g'} \simeq \B'$.

We can derive from that
$\G' \vdash \Prod{\x}{\subst{\A''}{\g}}{\subst{\B''}{\g'}}
\simeq \Prod{\x}{\A'}{\B'}$.
However, \meta{magically},
$\G' \vdash \Prod{\x}{\subst{\A''}{\g}}{\subst{\B''}{\g'}}
\simeq \subst{(\Prod{\x}{\A''}{\B''})}{\g}$,
which gives the expected conclusion by transitivity.
(\meta{We should write it in a better way.})

\Case{ty-id}

Consider
%
\begin{equation*}
  \infer{
    \istype{\G}{\A} \\
    \isterm{\G}{\uu}{\A} \\
    \isterm{\G}{\vv}{\A}
  }
  {\istype{\G}{\Id{\A}{\uu}{\vv}}}
\end{equation*}
%
First, let us handle~\eqref{lbl:ty-ctr}. Assume $\G'$ a translation of $\G$.
From~\eqref{lbl:ty-ctr}, we get $\istype{\G'}{\A'}$ and
from~\eqref{lbl:term-ctr} using $\G'$ and $\A'$, we get
$\isterm{\G'}{\uu'}{\A'}$ and $\isterm{\G'}{\vv'}{\A'}$.
We finally have $\istype{\G'}{\Id{\A'}{\uu'}{\vv'}}$.

\sloppy
Now, let us prove~\eqref{lbl:ty-path} by assuming $\istype{\G'}{\C''}$ another
translation of $\istype{\G}{\Id{\A}{\uu}{\vv}}$.
Using the same trick as before, \eqref{lbl:ty-path} and~\eqref{lbl:term-path},
and the \meta{magic} fact that
%
\begin{equation*}
  \G' \vdash \Id{\subst{\A''}{\g}}{\subst{\uu''}{\g}}{\subst{\vv''}{\g}}
  \simeq \subst{(\Id{\A''}{\uu''}{\vv''})}{\g},
\end{equation*}
%
we can conclude.

\Case{term-ty-conv}

Consider
%
\begin{equation*}
  \infer{
    \isterm{\G}{\uu}{\A} \\
    \eqtype{\G}{\A}{\B}
  }
  {\isterm{\G}{\uu}{\B}}
\end{equation*}
%
This time we have to prove~\eqref{lbl:term-ctr} and~\eqref{lbl:term-path}.
First, for~\eqref{lbl:term-ctr}, assume $\G'$ and $\B'$ respective translations
of $\G$ and $\B$. From that and~\eqref{lbl:eq-ty-path} we get
$\istype{\G'}{\A'}$ and some equivalence $\G' \vdash \A' \simeq \B'$.
From $\G'$, $\A'$ and~\eqref{lbl:term-ctr}, we get $\isterm{\G'}{\uu'}{\A'}$.
We take the direct map from the equivalence $\f$ and finally
conclude $\isterm{\G'}{\app{\f}{\_}{\A'}{\B'}{\uu'}}{\B'}$.

Now, for~\eqref{lbl:term-path}, assume another translation
$\isterm{\G'}{\uu''}{\B'}$.
Using $\g$, the inverse of $\f$, we get
$\isterm{\G'}{\app{\g}{\_}{\B'}{\A'}{\uu''}}{\A'}$ which is a valid translation
thanks to the remarks. Thus, using~\eqref{lbl:term-path}, we get an equivalence
$\G' \vdash \app{\g}{\_}{\B'}{\A'}{\uu''} \simeq \uu' : \A'$.
From it we deduce the equivalence
$\G' \vdash \app{\f}{\_}{\A'}{\B'}{(\app{\g}{\_}{\B'}{\A'}{\uu''})}
\simeq \app{\f}{\_}{\A'}{\B'}{\uu'} : \A'$.
Since $\f$ and $\g$ are inverses, we have
$\G' \vdash \app{\f}{\_}{\A'}{\B'}{(\app{\g}{\_}{\B'}{\A'}{\uu''})}
\simeq \uu'' : \A'$ and so
$\G' \vdash \uu'' \simeq \app{\f}{\_}{\A'}{\B'}{\uu'} : \A'$.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
