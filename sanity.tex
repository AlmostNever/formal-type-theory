\section{Type theory is well formed}
\label{sec:type-theory-well}

\begin{theorem}
  Type theory is well formed in the following sense:
  %
  \begin{enumerate}
  \item \label{sane-issubst} if $\issubst{\sbs}{\G}{\D}$ then $\isctx{\G}$ and $\isctx{\D}$,
  \item \label{sane-istype}  if $\istype{\G}{\A}$ then $\isctx{\G}$,
  \item \label{sane-isterm}  if $\isterm{\G}{\uu}{\A}$ then $\istype{\G}{\A}$,
  \item \label{sane-eqctx}   if $\eqctx{\G}{\D}$ then $\isctx{\G}$ and $\isctx{\D}$,
  \item \label{sane-eqtype}  if $\eqtype{\G}{\A}{\B}$ then $\istype{\G}{\A}$ and $\istype{\G}{\B}$,
  \item \label{sane-eqterm}  if $\eqterm{\G}{\uu}{\vv}{\A}$ then $\isterm{\G}{\uu}{\A}$ and $\isterm{\G}{\vv}{\A}$.
  \end{enumerate}
\end{theorem}

The rest of this section contains the proof, which proceeds by structural induction on the
derivation.

\subsection{Contexts \fbox{$\isctx{\G}$}}

The rules $\rl{ctx-empty}$ and $\rl{ctx-extend}$ need not be considered.

\subsection{Substitutions \fbox{$\issubst{\sbs}{\G}{\D}$}}

This section proves clause \eqref{sane-issubst} of the theorem.

\subsubsection*{Rule $\rl{subst-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{subst-id}]
  {\isctx{\G}}
  {\issubst{\sbid{\G}}{\G}{\G}}
\end{equation*}
%
By the premise we have $\isctx{\G}$.

\subsubsection*{Rule $\rl{subst-compose}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E}
  }
  {\issubst{\sbcomp{\sbt}{\sbs}}{\G}{\E}}
\end{equation*}
%
By induction hypothesis on the left premise $\isctx{\G}$ follows, and by induction
hypothesis on the right premise $\isctx{\E}$.

\subsubsection*{Rule $\rl{subst-extend}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{subst-extend}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\G}{\uu}{\subst{\A}{\sbs}}
  }
  {\issubst
     {(\sbextend{\sbs}{\A}{\uu})}
     {\G}
     {(\ctxextend{\D}{\A})}
  }
\end{equation*}
%
Then $\isctx{\G}$ by induction hypothesis on the left premise, while
$\isctx{(\ctxextend{\D}{\A})}$ follows by the induction hypothesis on the middle
premise and an application of $\rl{ctx-extend}$.

\subsubsection*{Rule $\rl{subst-weak}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{subst-weak}]
  {\istype{\G}{\A}}
  {\issubst
     {\sbweak{\G}{\A}}
     {\ctxextend{\G}{\A}}
     {\G}
  }
\end{equation*}
%
First, $\isctx{\G}$ follows by induction hypothesis on the premise, and then
$\isctx{\ctxextend{\G}{\A}}$ by an application of $\rl{ctx-extend}$.

\subsection{Types \fbox{$\istype{\G}{\A}$}}

In this section we prove clause \eqref{sane-istype}.

\subsubsection*{Rule $\rl{ty-ctx-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{ty-ctx-conv}]
  {\istype{\G}{\A} \\
    \eqctx{\G}{\D}
  }
  {\istype{\D}{\A}}
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\D}$.

\subsubsection*{Rule $\rl{ty-subst}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{ty-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A}
  }
  {\istype{\G}{\subst{\A}{\sbs}}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsubsection*{Rule $\rl{ty-prod}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{ty-prod}]
  { \istype{\G}{\A} \\
    \istype{\ctxextend{\G}{\A}}{\B}}
  {\istype{\G}{\Prod{\A}{\B}}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsubsection*{Rule $\rl{ty-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{ty-id}]
  {\istype{\G}{\A}\\
   \isterm{\G}{\uu}{\A}\\
   \isterm{\G}{\vv}{\A}
  }
  {\istype{\G}{\Id{\A}{\uu}{\vv}}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsection{Terms \fbox{$\isterm{\G}{\uu}{\A}$}}

In this section we prove clause \eqref{sane-isterm}.

\subsubsection*{Rule $\rl{term-ty-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-ty-conv}]
  {\isterm{\G}{\uu}{\A} \\
   \eqtype{\G}{\A}{\B}
  }
  {\isterm{\G}{\uu}{\B}}
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\G}{\B}$.


\subsubsection*{Rule $\rl{term-ctx-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-ctx-conv}]
  {\isterm{\G}{\uu}{\A} \\
   \eqctx{\G}{\D}
  }
  {\isterm{\D}{\uu}{\A}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$, and then we apply
$\rl{ty-ctx-conv}$ using the right premise.


\subsubsection*{Rule $\rl{term-subst}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\uu}{\A}
  }
  {\isterm{\G}{\subst{\uu}{\sbs}}{\subst{\A}{\sbs}}}
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\D}{\A}$, and then we
apply $\rl{ty-subst}$ using the left premise.

\subsubsection*{Rule $\rl{term-var}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-var}]
  {
   \istype{\G}{\A}
  }
  {\isterm
     {\ctxextend{\G}{\A}}
     {\var{0}}
     {\subst{\A}{\sbweak{\G}{\A}}}
  }
\end{equation*}
%
We apply $\rl{subst-weak}$ to the premise to obtain
$\issubst{\sbweak{\G}{\A}}{\ctxextend{\G}{\A}}{\G}$. Then we apply $\rl{ty-subst}$ to it
and to the premise.

\subsubsection*{Rule $\rl{term-var-skip}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-var-skip}]
  {\isterm{\G}{\var{k}}{\A} \\
   \istype{\G}{\B}
  }
  {\isterm
     {\ctxextend{\G}{\B}}
     {\var{k+1}}
     {\subst{\A}{\sbweak{\G}{\B}}}
  }
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$. We
apply $\rl{ty-subst}$ to it and to $\rl{subst-weak}$ applied to the
right premise.


\subsubsection*{Rule $\rl{term-abs}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-abs}]
  {\istype{\G}{\A} \\
   \isterm{\ctxextend{\G}{\A}}{\uu}{\B}}
  {\isterm{\G}{(\lam{\A}{\B}{\uu})}{\Prod{\A}{\B}}}
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\ctxextend{\G}{\A}}{\B}$,
after which we apply $\rl{ty-prod}$ to it and to the left premise.


\subsubsection*{Rule $\rl{term-app}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-app}]
  {\istype{\ctxextend{\G}{\A}}{\B} \\
   \isterm{\G}{\uu}{\Prod{\A} \B} \\
   \isterm{\G}{\vv}{\A}
  }
  {\isterm
    {\G}
    {\app{\uu}{\A}{\B}{\vv}}
    {\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}}}
  }
\end{equation*}
%
We first argue that we may apply $\rl{subst-extend}$ as follows:
%
\begin{equation*}
  \inferrule*
  {
   \inferrule*{\isctx{\G}}{\issubst{\sbid{\G}}{\G}{\G}}
   \\
   \istype{\G}{\A} \\
   \inferrule*
      {\isterm{\G}{\vv}{\A} \\
       \eqtype{\G}{\A}{\subst{\A}{\sbid{\G}}}
      }
      {\isterm{\G}{\vv}{\subst{\A}{\sbid{\G}}}}
  }
  {\issubst
   {(\sbextend{\sbid{\G}}{\A}{\vv})}
   {\G}
   {\ctxextend{\G}{\A}}
  }
\end{equation*}
%
The left premise of this derivation follows by $\rl{ctx-id}$, which in turn is
justified by \meta{\{something missing: several solutions like strengthening
the theorem/program, adding $\istype{\G}{\A}$ as a premise to $\rl{term-app}$ or
devise a way to call the induction hypothesis on its result. \}}

\subsubsection*{Rule $\rl{term-refl}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{term-refl}]
  {\isterm{\G}{\uu}{\A}}
  {\isterm{\G}{\refl{\A} \uu}{\Id{\A}{\uu}{\uu}}}
\end{equation*}
%
By induction hypothesis on the premise we obtain $\istype{\G}{\A}$
and then by using $\rl{ty-id}$ on it and on the premise itself twice,
we conclude $\istype{\G}{\Id{\A}{\uu}{\uu}}$.

\subsection{Context equality \fbox{$\eqctx{\G}{\D}$}}

In this section we prove clause~\eqref{sane-eqctx}.

\subsubsection*{Rule $\rl{eq-ctx-empty}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ctx-empty}]
  { }
  {\eqctx{\ctxempty}{\ctxempty}}
\end{equation*}
%
By $\rl{ctx-empty}$, $\isctx{\ctxempty}$ holds.

\subsubsection*{Rule $\rl{eq-ctx-extend}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ctx-extend}]
  {
   \eqtype{\G}{\A}{\B}
  }
  {\eqctx{(\ctxextend{\G}{\A})}{(\ctxextend{\G}{\B})}}
\end{equation*}
%
We apply $\rl{ctx-extend}$ twice to the induction hypotheses to conclude
$\isctx{\ctxextend{\G}{\A}}$ and $\isctx{\ctxextend{\D}{\B}}$.


\subsection{Type equality \fbox{$\eqtype{\G}{\A}{\B}$}}

In this section we prove clause~\eqref{sane-eqtype}.

\subsubsection*{Rule $\rl{eq-ty-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-conv}]
  {\eqtype{\G}{\A}{\B}\\
    \eqctx{\G}{\D}}
  {\eqtype{\D}{\A}{\B}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$
and $\istype{\G}{\B}$.
Using $\rl{ty-ctx-conv}$ on both combined with the right premise we obtain
$\istype{\D}{\A}$ and $\istype{\D}{\B}$.

\subsubsection*{Rule $\rl{eq-ty-refl}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-refl}]
  {\istype{\G}{\A}}
  {\eqtype{\G}{\A}{\A}}
\end{equation*}
%
We have $\istype{\G}{\A}$ as premise.

\subsubsection*{Rule $\rl{eq-ty-sym}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-sym}]
  {\eqtype{\G}{\B}{\A}}
  {\eqtype{\G}{\A}{\B}}
\end{equation*}
%
By induction hypothesis on the premise, we conclude.

\subsubsection*{Rule $\rl{eq-ty-trans}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-trans}]
  {\eqtype{\G}{\A}{\B}\\
   \eqtype{\G}{\B}{\C}}
  {\eqtype{\G}{\A}{\C}}
\end{equation*}
%
By induction hypothesis on the premises, we conclude.

\subsubsection*{Rule $\rl{eq-ty-subst-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-subst-id}]
  {\istype{\G}{\A}}
  {\eqtype{\G}
     {\subst{\A}{\sbid{\G}}}
     {\A}
  }
\end{equation*}
%
We have $\istype{\G}{\A}$ as premise. We derive $\issubst{\sbid{\G}}{\G}{\G}$ from the
induction hypothesis by $\rl{subst-id}$, and use it in $\rl{ty-subst}$ to conclude
$\istype{\G}{\subst{\A}{\sbid{\G}}}$.

\subsubsection*{Rule $\rl{eq-ty-subst-compose}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E} \\
   \istype{\E}{\A}
  }
  {\eqtype{\G}
    {\subst{\A}{\sbcomp{\sbs}{\sbt}}}
    {\subst{(\subst{\A}{\sbs})}{\sbt}}
  }
\end{equation*}
%
We use the first two premises and $\rl{subst-compose}$ to derive
$\issubst{\sbcomp{\sbs}{\sbt}}{\G}{\E}$, which we then use in $\rl{ty-subst}$ to obtain
$\istype{\G}{\subst{\A}{\sbcomp{\sbs}{\sbt}}}$. Similarly, we apply $\rl{ty-subst}$ twice
on the premises to conclude $\istype{\G}{\subst{(\subst{\A}{\sbs})}{\sbt}}$.

\subsubsection*{Rule $\rl{eq-ty-subst-prod}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-subst-prod}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \istype{\ctxextend{\D}{\A}}{\B}
  }
  {\eqtype{\G}
   {\subst{(\Prod{\A}{\B})}{\sbs}}
   {\Prod
     {\subst{\A}{\sbs}}
     {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}
   }
  }
\end{equation*}
%
Using $\rl{ty-prod}$ and $\rl{ty-subst}$ we get
$\istype{\G}{\subst{(\Prod{\A}{\B})}{\sbs}}$.
An application of $\rl{ty-subst}$ yields $\istype{\G}{\subst{\A}{\sbs}}$
and a slightly more complicated one
$\istype{\ctxextend{\G}{\subst{\A}{\sbs}}}{\subst{\B}{\sbshift{\sbs}{\G}{\A}}}$.
We now apply $\rl{ty-prod}$ to conclude
$\istype
  {\G}
  {\Prod
    {\subst{\A}{\sbs}}
    {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}}$.

\subsubsection*{Rule $\rl{eq-ty-subst-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-subst-id}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\D}{\uu}{\A} \\
   \isterm{\D}{\vv}{\A}
  }
  {\eqtype{\G}
   {\subst{(\Id{\A}{\uu}{\vv})}{\sbs}}
   {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\vv}{\sbs}}}
  }
\end{equation*}
%
We apply $\rl{ty-id}$ and $\rl{ty-subst}$ to the premises to get
$\istype{\G}{\subst{(\Id{\A}{\uu}{\vv})}{\sbs}}$. Then we apply $\rl{ty-subst}$ and
$\rl{term-subst}$ on the last three premises and put the results together using
$\rl{ty-id}$ to get
$\istype{\G}{\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\vv}{\sbs}}}$.

\subsubsection*{Rule $\rl{cong-prod}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-prod}]
  {\eqtype{\G}{\A_1}{\B_1}\\
   \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}}
  {\eqtype{\G}{\Prod{\A_1}{\A_2}}{\Prod{\B_1}{\B_2}}}
\end{equation*}
%
The induction hypotheses yield $\istype{\G}{\A_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\A_2}$, as well as $\istype{\G}{\B_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\B_2}$. We may conclude $\istype{\G}{\Prod{A_1} A_2}$ and
$\istype{\G}{\Prod{B_1} B_2}$ by $\rl{ty-prod}$, provided we derive
$\istype{\ctxextend{\G}{\B_1}}{\B_2}$. To do so, we first derive
$\eqctx{\ctxextend{\G}{\A_1}}{\ctxextend{\G}{\B_1}}$ by $\rl{eq-ctx-extend}$ and then
apply $\rl{ty-ctx-conv}$ to $\istype{\ctxextend{\G}{\A_1}}{\B_2}$.

\subsubsection*{Rule $\rl{cong-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-id}]
  {\eqtype{\G}{\A}{\B}\\
   \eqterm{\G}{\uu_1}{\vv_1}{\A}\\
   \eqterm{\G}{\uu_2}{\vv_2}{\A}
  }
  {\eqtype{\G}{\Id{\A}{\uu_1}{\uu_2}}
              {\Id{\B}{\vv_1}{\vv_2}}}
\end{equation*}
%
We apply $\rl{ty-id}$ to the induction hypotheses to get
$\istype{\G}{\Id{\A}{\uu_1}{\uu_2}}$. We obtain $\istype{\G}{\Id{\B}{\vv_1}{\vv_2}}$ in
the same way, but use $\rl{term-ty-conv}$ on the last two induction hypotheses beforehand.

\subsubsection*{Rule $\rl{cong-ty-subst}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-ty-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \eqtype{\D}{\A}{\B}
  }
  {\eqtype{\G}{\subst{\A}{\sbs}}{\subst{\B}{\sbs}}}
\end{equation*}
%
We apply $\rl{ty-subst}$ on the left premise and the induction hypothesis
applied to the right premise to conclude.

\goodbreak

\subsection{Term equality \fbox{$\eqterm{\G}{\uu_1}{\uu_2}{\A}$}}

This section proves clause \eqref{sane-eqterm}.



\subsubsection*{Rule $\rl{eq-ty-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ty-conv}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
    \eqtype{\G}{\A}{\B}}
  {\eqterm{\G}{\uu}{\vv}{\B}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isterm{\G}{\uu}{\A}$
and $\isterm{\G}{\vv}{\A}$. Then using $\rl{term-ty-conv}$ on both and on the
right premise, we conclude $\isterm{\G}{\uu}{\B}$ and $\isterm{\G}{\vv}{\B}$.

\subsubsection*{Rule $\rl{eq-ctx-conv}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-ctx-conv}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
    \eqctx{\G}{\D}}
  {\eqterm{\D}{\uu}{\vv}{\A}}
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isterm{\G}{\uu}{\A}$
and $\isterm{\G}{\vv}{\A}$. Then using $\rl{term-ctx-conv}$ on both and on the
right premise, we conclude $\isterm{\D}{\uu}{\A}$ and $\isterm{\D}{\vv}{\A}$.

\subsubsection*{Rule $\rl{eq-refl}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-refl}]
  {\isterm{\G}{\uu}{\A}}
  {\eqterm{\G}{\uu}{\uu}{\A}}
\end{equation*}
%
We have $\isterm{\G}{\uu}{\A}$ as a premise.

\subsubsection*{Rule $\rl{eq-sym}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-sym}]
  {\eqterm{\G}{\vv}{\uu}{\A}}
  {\eqterm{\G}{\uu}{\vv}{\A}}
\end{equation*}
%
We conclude immediately using the induction hypothesis.

\subsubsection*{Rule $\rl{eq-trans}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-trans}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
   \eqterm{\G}{\vv}{\ww}{\A}}
  {\eqterm{\G}{\uu}{\ww}{\A}}
\end{equation*}
%
We conclude immediately using the induction hypotheses.

\subsubsection*{Rule $\rl{eq-subst-id}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-id}]
  {\isterm{\G}{\uu}{\A}}
  {\eqterm{\G}
     {\subst{\uu}{\sbid{\G}}}
     {\uu}
     {\A}
  }
\end{equation*}
%
We have $\isterm{\G}{\uu}{\A}$ as a premise.
Moreover, \meta{\{how do we get it?\}}, $\isctx{\G}$ and so
$\issubst{\sbid{\G}}{\G}{\G}$. Then, applying $\rl{term-subst}$ on it and
the premise, we get
$\isterm{\G}{\subst{\uu}{\sbid{\G}}}{\subst{\A}{\sbid{\G}}}$.
Similarly, using $\rl{eq-ty-subst-id}$ on the induction hypothesis yielding
$\istype{\G}{\A}$, we derive $\eqtype{\G}{\subst{\A}{\sbid{\G}}}{\A}$.
With $\rl{term-ty-conv}$ we conclude
$\isterm{\G}{\subst{\uu}{\sbid{\G}}}{\A}$.

\subsubsection*{Rule $\rl{eq-subst-compose}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E} \\
   \isterm{\E}{\uu}{\A}
  }
  {\eqterm{\G}
    {\subst{\uu}{\sbcomp{\sbs}{\sbt}}}
    {\subst{(\subst{\uu}{\sbs})}{\sbt}}
    {\subst{\A}{\sbcomp{\sbs}{\sbt}}}
  }
\end{equation*}
%
Using $\rl{subst-compose}$ to the first two premises we get
$\issubst{\sbcomp{\sbs}{\sbt}}{\G}{\E}$. Then applying $\rl{term-subst}$
to it and the right premise yields
$\isterm{\G}{\subst{\uu}{\sbcomp{\sbs}{\sbt}}}{\subst{\A}{\sbcomp{\sbs}{\sbt}}}$.
%
Applying $\rl{term-subst}$ twice on the premises yields
$\isterm{\G}{\subst{(\subst{\uu}{\sbs})}{\sbt}}{\subst{(\subst{\A}{\sbs})}{\sbt}}$. It
remains to apply $\rl{term-ty-conv}$, for which we need
$\eqtype{\G}{\subst{(\subst{\A}{\sbs})}{\sbt}}{\subst{\A}{\sbcomp{\sbs}{\sbt}}}$. By
induction hypothesis on the right premise we get $\istype{\E}{\A}$, to which we apply
$\rl{eq-ty-subst-compose}$ and finally $\rl{eq-ty-sym}$.



\subsubsection*{Rule $\rl{eq-subst-weak}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-weak}]
  {\isterm{\G}{\var{k}}{\A} \\
   \istype{\G}{\B}
  }
  {\eqterm{\ctxextend{\G}{\B}}
   {\subst{\var{k}}{\sbweak{\G}{\B}}}
   {\var{k+1}}
   {\subst{\A}{\sbweak{\G}{\B}}}
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-subst-extend-zero}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-extend-zero}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\G}{\uu}{\subst{\A}{\sbs}}
  }
  {\eqterm{\G}
     {\subst{\var{0}}{\sbextend{\sbs}{\A}{\uu}}}
     {\uu}
     {\subst{\A}{\sbs}}
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-subst-extend-succ}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-extend-succ}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\var{k}}{\A} \\
   \isterm{\G}{\uu}{\subst{\B}{\sbs}}
  }
  {\eqterm{\G}
     {\subst
        {\var{k+1}}
        {\sbextend{\sbs}{\B}{\uu}}
     }
     {\subst{\var{k}}{\sbs}}
     {\subst{\A}{\sbs}}
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-subst-abs}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-abs}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\ctxextend{\D}{\A}}{\uu}{\B}
  }
  {\eqterm{\G}
    {\subst{(\lam{\A}{\B} \uu)}{\sbs}}
    {(\lam
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
      \subst{\uu}{\sbextend{\sbs}{\A}{\var{0}}})
    }
    {\Prod
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
    }
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-subst-app}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-app}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\ctxextend{\D}{\A}}{\B} \\
   \isterm{\D}{\uu}{\Prod{\A}{\B}} \\
   \isterm{\D}{\vv}{\A}
  }
  {\eqterm{\G}
   {\subst{(\app{\uu}{\A}{\B}{\vv})}{\sbs}}
   {\app
      {\subst{\uu}{\sbs}}
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
      {\subst{\vv}{\sbs}}}
   {\subst
     {(\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}})}
     {\sbs}
   }
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-subst-refl}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-subst-refl}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\uu}{\A}
  }
  {\eqterm{\G}
   {\subst{(\refl{\A}{\uu})}{\sbs}}
   {\refl{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}}
   {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\uu}{\sbs}}}
  }
\end{equation*}

\subsubsection*{Rule $\rl{eq-reflection}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{eq-reflection}]
  {\isterm{\G}{\ww_1}{\Id{\A}{\uu}{\vv}} \\
   \isterm{\G}{\ww_2}{\textsf{UIP}(\A)}
  }
  {\eqterm{\G}{\uu}{\vv}{\A}}
\end{equation*}


\subsubsection*{Rule $\rl{prod-beta}$}

Consider a derivation ending with
%
\begin{equation*}
\infer[\rl{prod-beta}]
  {\isterm{\ctxextend{\G}{\A}}{\uu}{\B}\\
    \isterm{\G}{\vv}{\A}}
  {\eqterm{\G}{\bigl(\app{(\lam{\A}{\B}{\uu})}{\A}{\B}{\vv}\bigr)}
              {\subst{\uu}{\sbextend{\sbid{\G}}{\A}{\vv}}}
              {\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}}}}
\end{equation*}

\subsubsection*{Rule $\rl{prod-eta}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{prod-eta}]
  {\isterm{\G}{\uu}{\Prod{\A}{\B}}\\
   \isterm{\G}{\vv}{\Prod{\A}{\B}}\\\\
   \eqterm
      {\ctxextend{\G}{\A}}
      {(\app
          {\subst{\uu}{\sbweak{\G}{\A}}}
          {\subst{\A}{\sbweak{\G}{\A}}}
          {\subst
            {\B}
            {\sbshift
              {\sbweak{\G}{\A}}
              {\ctxextend{\G}{\A}}
              {\A}
            }
          }
          {\var{0}})
      }
      {(\app
          {\subst{\vv}{\sbweak{\G}{\A}}}
          {\subst{\A}{\sbweak{\G}{\A}}}
          {\subst
            {\B}
            {\sbshift
              {\sbweak{\G}{\A}}
              {\ctxextend{\G}{\A}}
              {\A}
            }
          }
          {\var{0}})
      }
      {\B}
  }
  {\eqterm{\G}{\uu}{\vv}{\Prod{\A}{\B}}}
\end{equation*}

\subsubsection*{Rule $\rl{cong-abs}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-abs}]
  {\eqtype{\G}{\A_1}{\B_1}\\
    \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}\\
    \eqterm{\ctxextend{\G}{\A_1}}{\uu_1}{\uu_2}{\A_2}}
  {\eqterm{\G}{(\lam{\A_1}{\A_2}{\uu_1})}
              {(\lam{\B_1}{\B_2}{\uu_2})}
              {\Prod{\A_1}{\A_2}}}
\end{equation*}

\subsubsection*{Rule $\rl{cong-app}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-app}]
  {\eqtype{\G}{\A_1}{\B_1}\\
   \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}\\\\
   \eqterm{\G}{\uu_1}{\vv_1}{\Prod{\A_1}{\A_2}}\\
   \eqterm{\G}{\uu_2}{\vv_2}{\A_1}}
  {\eqterm
    {\G}
    {(\app{\uu_1}{\A_1}{\A_2}{\uu_2})}
    {(\app{\vv_1}{\B_1}{\B_2}{\vv_2})}
    {\subst{\A_2}{\sbextend{\sbid{\G}}{\A_1}{\uu_2}}}
  }
\end{equation*}

\subsubsection*{Rule $\rl{cong-refl}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-refl}]
  {\eqterm{\G}{\uu_1}{\uu_2}{\A_1}\\
    \eqtype{\G}{\A_1}{\A_2}}
  {\eqterm{\G}{\refl{\A_1} \uu_1}{\refl{\A_2} \uu_2}{\Id{\A_1}{\uu_1}{\uu_1}}}
\end{equation*}

\subsubsection*{Rule $\rl{cong-term-subst}$}

Consider a derivation ending with
%
\begin{equation*}
  \infer[\rl{cong-term-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \eqterm{\D}{\uu_1}{\uu_2}{\A}
  }
  {\eqterm{\G}{\subst{\uu_1}{\sbs}}{\subst{\uu_2}{\sbs}}{\subst{\A}{\sbs}}}
\end{equation*}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
