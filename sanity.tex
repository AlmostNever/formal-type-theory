\section{Type theory is well formed}
\label{sec:type-theory-well}

Because of the reflection rule, we want to have a simple construction that
extracts the well-typedness of a derivation of
$\istype{\G}{\Id{\A}{\uu}{\vv}}$.

\begin{problem}
  \label{pbm:id-inversion}
  Given $\istype{\G}{\Id{\A}{\uu}{\vv}}$, construct
  $\istype{\G}{\A}$, $\isterm{\G}{\uu}{\A}$ and $\isterm{\G}{\vv}{\A}$.
\end{problem}
%
\begin{proof}[Construction]
  We proceed by induction on the derivation of $\istype{\G}{\Id{\A}{\uu}{\vv}}$.
  There are two possible cases:

  \begin{enumerate}
    \item The last rule is
      \begin{equation*}
        \showTyId
      \end{equation*}
      %
      We conclude immediately using its premises.
    \item The last rule is
      \begin{equation*}
        % \showTyCtxConv
        \infer[\rulename{ty-ctx-conv}]
        {\istype{\G}{\Id{\A}{\uu}{\vv}} \\
          \eqctx{\G}{\D}
        }
        {\istype{\D}{\Id{\A}{\uu}{\vv}}}
      \end{equation*}
      %
      By induction hypothesis, we have $\istype{\G}{\A}$,
      $\isterm{\G}{\uu}{\A}$ and $\isterm{\G}{\vv}{\A}$.
      Then, using {\rlTyCtxConv} and {\rlTermCtxConv} we conclude
      $\istype{\D}{\A}$, $\isterm{\D}{\uu}{\A}$ and $\isterm{\D}{\vv}{\A}$.
  \end{enumerate}
\end{proof}

% We want the following construction to be just a simple structural recursion on the derivation.
% It should not use any admissibility results, or nested forms of induction.
% The reasons for this are:
% * this is a sanity theorem showing that type theory contains no garbage, and as such should come *before* other results
% * in the anticipated translation of ETT to ITT we will suffer each time we use an inner induction (really?)

\begin{problem}
  \leavevmode
  %
  \begin{enumerate}
  \item \label{sane-issubst} Given $\issubst{\sbs}{\G}{\D}$ construct
    \begin{enumerate}
    \item $\isctx{\G}$,
    \item $\isctx{\D}$,
    \end{enumerate}
  \item \label{sane-istype}  given $\istype{\G}{\A}$ construct $\isctx{\G}$,
  \item \label{sane-isterm}  given $\isterm{\G}{\uu}{\A}$ construct
    \begin{enumerate}
    \item $\isctx{\G}$,
    \item $\istype{\G}{\A}$,
    \end{enumerate}
  \item \label{sane-eqctx}   given $\eqctx{\G}{\D}$ construct
    \begin{enumerate}
    \item $\isctx{\G}$,
    \item $\isctx{\D}$,
    \end{enumerate}
  \item \label{sane-eqtype}  given $\eqtype{\G}{\A}{\B}$ construct
    \begin{enumerate}
    \item $\isctx{\G}$,
    \item $\istype{\G}{\A}$,
    \item $\istype{\G}{\B}$,
    \end{enumerate}
  \item \label{sane-eqterm}  given $\eqterm{\G}{\uu}{\vv}{\A}$ construct
    \begin{enumerate}
    \item $\isctx{\G}$,
    \item $\istype{\G}{\A}$,
    \item $\istype{\G}{\B}$,
    \item $\isterm{\G}{\uu}{\A}$,
    \item $\isterm{\G}{\vv}{\A}$.
    \end{enumerate}
  \end{enumerate}
\end{problem}
%
The rest of this section contains the construction, which proceeds by structural induction on the
derivation.


\subsection{Contexts \fbox{$\isctx{\G}$}}

\subsubsection*{Rule {\rlCtxEmpty}}

We need not consider this rule.
% But do not delete this without understanding what verify.sh does.

\subsubsection*{Rule {\rlCtxExtend}}

We need not consider this rule.
% But do not delete this without understanding what verify.sh does.

\subsection{Substitutions \fbox{$\issubst{\sbs}{\G}{\D}$}}

This section proves clause \eqref{sane-issubst} of the theorem.


\subsubsection*{Rule {\rlSubstZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstZero
\end{equation*}
%
By induction hypothesis $\isctx{\G}$ and $\istype{\G}{\A}$. We get
$\isctx{(\ctxextend{\G}{\A})}$ by {\rlCtxExtend}.

% ENDS WITH IH Contexts
% ENDS WITH CtxExtend


\subsubsection*{Rule {\rlSubstWeak}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstWeak
\end{equation*}
%
First, $\isctx{\G}$ follows by induction hypothesis on the premise, and then
$\isctx{\ctxextend{\G}{\A}}$ by an application of {\rlCtxExtend}.

% ENDS WITH IH Contexts
% ENDS WITH CtxExtend

\subsubsection*{Rule {\rlSubstShift}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstShift
\end{equation*}
%
By induction hypothesis $\isctx{\G}$ and $\isctx{\D}$. Then $\isctx{(\ctxextend{\D}{\A})}$
by {\rlCtxExtend}, while $\isctx{(\ctxextend{\G}{\subst{\A}{\sbs}})}$ by {\rlTySubst} and
{\rlCtxExtend}.

% ENDS WITH IH Contexts
% ENDS WITH CtxExtend

\subsection{Types \fbox{$\istype{\G}{\A}$}}

In this section we prove clause \eqref{sane-istype}.

\subsubsection*{Rule {\rlTyCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyCtxConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\D}$.

% ENDS WITH IH Contexts

\subsubsection*{Rule {\rlTySubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showTySubst
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

% ENDS WITH IH Contexts


\subsubsection*{Rule {\rlTyProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyProd
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

% ENDS WITH IH Contexts


\subsubsection*{Rule {\rlTyId}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyId
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

% ENDS WITH IH Contexts


\subsection{Terms \fbox{$\isterm{\G}{\uu}{\A}$}}

In this section we prove clause \eqref{sane-isterm}.

\subsubsection*{Rule {\rlTermTyConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermTyConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\G}$ and $\istype{\G}{\B}$.

% ENDS WITH IH Contexts
% ENDS WITH IH Types


\subsubsection*{Rule {\rlTermCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermCtxConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\D}$.
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$, and then we apply
{\rlTyCtxConv} using the right premise.

% ENDS WITH IH Contexts
% ENDS WITH TyCtxConv

\subsubsection*{Rule {\rlTermSubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermSubst
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.
By induction hypothesis on the right premise we obtain $\istype{\D}{\A}$, and then we
apply {\rlTySubst} using the left premise.

% ENDS WITH IH Contexts
% ENDS WITH TySubst


\subsubsection*{Rule {\rlTermVarZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermVarZero
\end{equation*}
%
By induction hypothesis we get $\isctx{\G}$, which we may extend to
$\isctx{(\ctxextend{\G}{\A})}$ by {\rlCtxExtend}.
%
We apply {\rlSubstWeak} to the premise to obtain
$\issubst{\sbweak{\G}{\A}}{\ctxextend{\G}{\A}}{\G}$. Then we apply {\rlTySubst} to it
and to the premise.

% ENDS WITH TySubst

\subsubsection*{Rule {\rlTermVarSucc}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermVarSucc
\end{equation*}
%
By induction hypothesis on the right premise we get $\isctx{\G}$, which we may extend to
$\isctx{(\ctxextend{\G}{\B})}$ by {\rlCtxExtend}.
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$. We
apply {\rlTySubst} to it and to {\rlSubstWeak} applied to the
right premise.

% ENDS WITH TySubst


\subsubsection*{Rule {\rlTermAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermAbs
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.
%
By induction hypothesis on the right premise we obtain $\istype{\ctxextend{\G}{\A}}{\B}$,
after which we apply {\rlTyProd} to it and to the left premise.

% ENDS WITH IH Contexts
% ENDS WITH TyProd

\subsubsection*{Rule {\rlTermApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermApp
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\G}$.
%
By {\rlSubstZero} we have $\issubst{\sbzero{\G}{\A}{\vv}}{\G}{\ctxextend{\G}{\A}}$, which
allows us to concluding by an application of {\rlTySubst} to the left premise.

% ENDS WITH IH Contexts
% ENDS WITH TySubst

\subsubsection*{Rule {\rlTermRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermRefl
\end{equation*}
%
By induction hypothesis on the premise we obtain $\isctx{\G}$ and $\istype{\G}{\A}$ and
then by using {\rlTyId} on it and on the premise itself twice, we conclude
$\istype{\G}{\Id{\A}{\uu}{\uu}}$.

% ENDS WITH IH Contexts
% ENDS WITH TyId

\subsection{Context equality \fbox{$\eqctx{\G}{\D}$}}

In this section we prove clause~\eqref{sane-eqctx}.

\subsubsection*{Rule {\rlEqCtxEmpty}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxEmpty
\end{equation*}
%
By {\rlCtxEmpty}, $\isctx{\ctxempty}$ holds.

% ENDS WITH CtxEmpty

\subsubsection*{Rule {\rlEqCtxExtend}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxExtend
\end{equation*}
%
We apply {\rlCtxExtend} twice to the induction hypotheses to conclude
$\isctx{\ctxextend{\G}{\A}}$ and $\isctx{\ctxextend{\D}{\B}}$.

% ENDS WITH CtxExtend

\subsection{Type equality \fbox{$\eqtype{\G}{\A}{\B}$}}

In this section we prove clause~\eqref{sane-eqtype}.

\subsubsection*{Rule {\rlEqTyCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyCtxConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\D}$.
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$
and $\istype{\G}{\B}$.
Using {\rlTyCtxConv} on both combined with the right premise we obtain
$\istype{\D}{\A}$ and $\istype{\D}{\B}$.

% ENDS WITH IH Contexts
% ENDS WITH TyCtxConv

\subsubsection*{Rule {\rlEqTyRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyRefl
\end{equation*}
%
$\isctx{\G}$ follows by induction hypothesis and
we have $\istype{\G}{\A}$ as premise.

% ENDS WITH IH Contexts
% ENDS WITH Premise Types

\subsubsection*{Rule {\rlEqTySym}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySym
\end{equation*}
%
By induction hypothesis on the premise, we conclude.

% ENDS WITH IH Contexts
% ENDS WITH IH Types

\subsubsection*{Rule {\rlEqTyTrans}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyTrans
\end{equation*}
%
By induction hypothesis on the premises, we conclude.

% ENDS WITH IH Contexts
% ENDS WITH IH Types

\subsubsection*{Rule {\rlEqTyWeakNat}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyWeakNat
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$ and then
using {\rlTySubst} on the two first premises we get
$\istype{\G}{\subst{\A}{\sbs}}$, hence
$\isctx{(\ctxextend{\G}{\subst{\A}{\sbs}})}$ by {\rlCtxExtend}.
%
Now, to prove
$\istype
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{(\subst{\B}{\sbweak{\D}{\A}})}{\sbshift{\G}{\A}{\sbs}}}
$,
we apply {\rlTySubst} to
$\issubst
  {(\sbshift{\G}{\A}{\sbs})}
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\ctxextend{\D}{\A}}
$, which we get by applying {\rlSubstShift} to the first two premises,
and to
$\istype{\ctxextend{\D}{\A}}{\subst{\B}{\sbweak{\D}{\A}}}$.
The last judgment is obtained by {\rlTySubst} applied to the right premise and
$\issubst{\sbweak{\D}{\A}}{\ctxextend{\D}{\A}}{\D}$,
obtained by {\rlSubstWeak} from the middle premise.
%
Finally, to prove
$\istype
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{(\subst{\B}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$, we also resort to the use of {\rlTySubst} twice starting with the right
premise, and applying consecutively $\issubst{\sbs}{\G}{\D}$ and
$\issubst{\sbweak{\G}{\subst{\A}{\sbs}}}{\ctxextend{\G}{\subst{\A}{\sbs}}}{\G}$.
The latter is well-typed thanks to {\rlSubstWeak} applied to
$\istype{\G}{\subst{\A}{\sbs}}$ which we got earlier.

% ENDS WITH TySubst
% ENDS WITH TySubst

\subsubsection*{Rule {\rlEqTyWeakZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyWeakZero
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$
and we have $\istype{\G}{\A}$ as a premise.
By induction hypothesis on the right premise we have $\istype{\G}{\B}$
and thus, by {\rlSubstWeak} and {\rlTySubst} we get
$\istype{\ctxextend{\G}{\B}}{\subst{\A}{\sbweak{\G}{\B}}}$.
Using {\rlSubstZero} on the right premise and {\rlTySubst} we conclude
$\istype{\G}{\subst{(\subst{\A}{\sbweak{\G}{\B}})}{\sbzero{\G}{\B}{\uu}}}$.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH TySubst
% ENDS WITH Premise Types

\subsubsection*{Rule {\rlEqTyShiftZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyShiftZero
\end{equation*}
%
By induction hypothesis on the left premise we get $\isctx{\G}$.
Using {\rlSubstZero} on the right hypothesis and then {\rlTySubst}
we obtain $\istype{\D}{\subst{\B}{\sbzero{\D}{\A}{\vv}}}$;
with {\rlTySubst} again we get
$\istype{\G}{\subst{(\subst{\B}{\sbzero{\D}{\A}{\vv}})}{\sbs}}$.
By induction hypothesis on the right premise we get $\istype{\D}{\A}$,
and then with {\rlSubstShift} and {\rlTySubst} we get
$\istype{\ctxextend{\G}{\subst{\A}{\sbs}}}{\subst{\B}{\sbshift{\G}{\A}{\sbs}}}$;
finally, by {\rlTermSubst} we have
$\isterm{\G}{\subst{\vv}{\sbs}}{\subst{\A}{\sbs}}$, and by {\rlSubstZero}
and {\rlTySubst} we conclude
$\istype{\G}
  {\subst
    {(\subst{\B}{\sbshift{\G}{\A}{\sbs}})}
    {\sbzero{\G}{\subst{\A}{\sbs}}{\subst{\vv}{\sbs}}}}
$.

% ENDS WITH IH Contexts
% ENDS WITH TySubst

\subsubsection*{Rule {\rlEqTyCongZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyCongZero
\end{equation*}
%
We have $\isctx{\G}$ by induction hypothesis.
Using {\rlEqCtxExtend} on the left premise, we get
$\eqctx
  {(\ctxextend{\G}{\A_1})}
  {(\ctxextend{\G}{\A_2})}
$ and thus by {\rlTyCtxConv}, we obtain $\istype{\ctxextend{\G}{\A_2}}{\B}$.
%
The induction hypothesis on the middle premise gives $\isterm{\G}{\uu_1}{\A_1}$ and
(after {\rlTermTyConv}) also $\isterm{\G}{\uu_2}{\A_2}$.
%
Then using {\rlSubstZero} and {\rlTySubst} we construct
$\istype{\G}{\subst{\B}{\sbzero{\G}{\A_1}{\uu_1}}}$ and
$\istype{\G}{\subst{\B}{\sbzero{\G}{\A_2}{\uu_2}}}$.

% ENDS WITH IH Contexts
% ENDS WITH TySubst


\subsubsection*{Rule {\rlEqTySubstProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySubstProd
\end{equation*}
%
Using the induction hypothesis on the left premise we get $\isctx{\G}$.
%
Using {\rlTyProd} and {\rlTySubst} we get
$\istype{\G}{\subst{(\Prod{\A}{\B})}{\sbs}}$.
An application of {\rlTySubst} yields $\istype{\G}{\subst{\A}{\sbs}}$
and a slightly more complicated one
$\istype{\ctxextend{\G}{\subst{\A}{\sbs}}}{\subst{\B}{\sbshift{\sbs}{\G}{\A}}}$.
We now apply {\rlTyProd} to conclude
$\istype
  {\G}
  {\Prod
    {\subst{\A}{\sbs}}
    {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}}$.

% ENDS WITH IH Contexts
% ENDS WITH TySubst
% ENDS WITH TyProd

\subsubsection*{Rule {\rlEqTySubstId}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySubstId
\end{equation*}
%
Using the induction hypothesis on the left premise we get $\isctx{\G}$.
%
We apply {\rlTyId} and {\rlTySubst} to the premises to get
$\istype{\G}{\subst{(\Id{\A}{\uu}{\vv})}{\sbs}}$. Then we apply {\rlTySubst} and
{\rlTermSubst} on the last three premises and put the results together using
{\rlTyId} to get
$\istype{\G}{\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\vv}{\sbs}}}$.

% ENDS WITH IH Contexts
% ENDS WITH TySubst
% ENDS WITH TyId

\subsubsection*{Rule {\rlCongProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongProd
\end{equation*}
%
The induction hypotheses yield $\isctx{\G}$, $\istype{\G}{\A_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\A_2}$, as well as $\istype{\G}{\B_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\B_2}$.
We may conclude $\istype{\G}{\Prod{A_1} A_2}$ and
$\istype{\G}{\Prod{B_1} B_2}$ by {\rlTyProd}, provided we derive
$\istype{\ctxextend{\G}{\B_1}}{\B_2}$. To do so, we first derive
$\eqctx{(\ctxextend{\G}{\A_1})}{(\ctxextend{\G}{\B_1})}$ by {\rlEqCtxExtend} and
then apply {\rlTyCtxConv} to $\istype{\ctxextend{\G}{\A_1}}{\B_2}$.

% ENDS WITH IH Contexts
% ENDS WITH TyProd

\subsubsection*{Rule {\rlCongId}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongId
\end{equation*}
%
Using the induction hypothesis on the left premise we get $\isctx{\G}$.
%
We apply {\rlTyId} to the induction hypotheses to get
$\istype{\G}{\Id{\A}{\uu_1}{\uu_2}}$. We obtain $\istype{\G}{\Id{\B}{\vv_1}{\vv_2}}$ in
the same way, but use {\rlTermTyConv} on the last two induction hypotheses beforehand.

% ENDS WITH IH Contexts
% ENDS WITH TyId

\subsubsection*{Rule {\rlCongTySubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongTySubst
\end{equation*}
%
Using the induction hypothesis on the left premise we get $\isctx{\G}$.
We apply {\rlTySubst} on the left premise and the induction hypothesis
applied to the right premise to conclude.

% ENDS WITH IH Contexts
% ENDS WITH TySubst


\subsection{Term equality \fbox{$\eqterm{\G}{\uu_1}{\uu_2}{\A}$}}

This section proves clause \eqref{sane-eqterm}.



\subsubsection*{Rule {\rlEqTyConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyConv
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$,
$\isterm{\G}{\uu}{\A}$, and $\isterm{\G}{\vv}{\A}$.
Then using {\rlTermTyConv} on both and on the
right premise, we conclude $\isterm{\G}{\uu}{\B}$ and $\isterm{\G}{\vv}{\B}$.
We get $\istype{\G}{\B}$ by induction hypothesis on the right premise.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH IH Terms
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlEqCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxConv
\end{equation*}
%
We first get $\isctx{\D}$ from the induction hypothesis on the right premise.
Then, by induction hypothesis on the left premise we obtain $\istype{\G}{\A}$,
$\isterm{\G}{\uu}{\A}$ and $\isterm{\G}{\vv}{\A}$.
Then using {\rlTyCtxConv} and {\rlTermCtxConv} on all of them and on the right
premise, we conclude $\istype{\D}{\A}$, $\isterm{\D}{\uu}{\A}$ and
$\isterm{\D}{\vv}{\A}$.

% ENDS WITH IH Contexts
% ENDS WITH TermCtxConv

\subsubsection*{Rule {\rlEqRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqRefl
\end{equation*}
%
We have $\isterm{\G}{\uu}{\A}$ as a premise and $\isctx{\G}$ and
$\istype{\G}{\A}$ by induction hypothesis.

% ENDS WITH Premise Terms
% ENDS WITH IH Contexts
% ENDS WITH IH Types

\subsubsection*{Rule {\rlEqSym}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSym
\end{equation*}
%
We conclude immediately using the induction hypothesis.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH IH Terms

\subsubsection*{Rule {\rlEqTrans}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTrans
\end{equation*}
%
We conclude immediately using the induction hypotheses.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH IH Terms


\subsubsection*{Rule {\rlEqSubstWeak}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstWeak
\end{equation*}
%
From the right premise we derive $\isctx{\ctxextend{\G}{\B}}$
by {\rlCtxExtend}.
By induction hypothesis on the left premise we get $\istype{\G}{\A}$
and then using {\rlTySubst} we obtain
$\istype{\ctxextend{\G}{\B}}{\subst{\A}{\sbweak{\G}{\B}}}$.
Using {\rlTermSubst} on the left premise we deduce
$\isterm
  {\ctxextend{\G}{\B}}
  {\subst{\var{k}}{\sbweak{\G}{\B}}}
  {\subst{\A}{\sbweak{\G}{\B}}}
$.
An application of {\rlTermVarSucc} on the premises let us conclude
$\isterm{\ctxextend{\G}{\B}}{\var{k+1}}{\subst{\A}{\sbweak{\G}{\B}}}$.

% ENDS WITH TermSubst
% ENDS WITH TermVarSucc



\subsubsection*{Rule {\rlEqSubstZeroZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstZeroZero
\end{equation*}
%
By induction hypothesis we can directly conclude $\isctx{\G}$ and
$\istype{\G}{\A}$. We have $\isterm{\G}{\uu}{\A}$ as a premise.
With {\rlTermVarZero} we derive
$\isterm{\ctxextend{\G}{\A}}{\var{0}}{\subst{\A}{\sbweak{\G}{\A}}}$.
With {\rlSubstZero} we get
$\issubst{\sbzero{\G}{\A}{\uu}}{\G}{\ctxextend{\G}{\A}}$,
and with {\rlTermSubst} we get
$\isterm{\G}
  {\subst{\var{0}}{\sbzero{\G}{\A}{\uu}}}
  {\subst{(\subst{\A}{\sbweak{\G}{\A}})}{\sbzero{\G}{\A}{\uu}}}
$.
Now, with {\rlEqTyWeakZero} and {\rlTermTyConv} we conclude
$\isterm{\G}
  {\subst{\var{0}}{\sbzero{\G}{\A}{\uu}}}
  {\A}
$.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH Premise Terms
% ENDS WITH TermTyConv


\subsubsection*{Rule {\rlEqSubstZeroSucc}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstZeroSucc
\end{equation*}
%
By induction hypothesis on the left premise we conclude $\isctx{\G}$ and
$\istype{\G}{\A}$ and $\isterm{\G}{\var{k}}{\A}$ is the premise itself.
From {\rlTermVarSucc} we derive
$\isterm{\ctxextend{\G}{\B}}{\var{k+1}}{\subst{\A}{\sbweak{\G}{\B}}}$.
With {\rlSubstZero} we get
$\issubst{\sbzero{\G}{\B}{\uu}}{\G}{\ctxextend{\G}{\B}}$,
and with {\rlTermSubst} we get
$\isterm{\G}
  {\subst{\var{k+1}}{\sbzero{\G}{\B}{\uu}}}
  {\subst{(\subst{\A}{\sbweak{\G}{\B}})}{\sbzero{\G}{\B}{\uu}}}
$.
Now, with {\rlEqTyWeakZero} and {\rlTermTyConv} we conclude
$\isterm{\G}
  {\subst{\var{k+1}}{\sbzero{\G}{\B}{\uu}}}
  {\A}
$.


% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH Premise Terms
% ENDS WITH TermTyConv


\subsubsection*{Rule {\rlEqSubstShiftZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstShiftZero
\end{equation*}
%
From {\rlTySubst} and {\rlCtxExtend} we get $\istype{\G}{\subst{\A}{\sbs}}$ and
then $\isctx{(\ctxextend{\G}{\subst{\A}{\sbs}})}$.
Then with {\rlSubstWeak} and {\rlTySubst} we get
$\istype
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{(\subst{\A}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.
From $\istype{\G}{\subst{\A}{\sbs}}$ and {\rlTermVarZero} we conclude
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\var{0}}
  {\subst{(\subst{\A}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.
In the same fashion, we get
$\isterm{\ctxextend{\D}{\A}}{\var{0}}{\subst{\A}{\sbweak{\D}{\A}}}$
and with {\rlTermSubst} and {\rlSubstShift} we obtain
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{\var{0}}{\sbshift{\G}{\A}{\sbs}}}
  {\subst{(\subst{\A}{\sbweak{\D}{\A}})}{\sbshift{\G}{\A}{\sbs}}}
$.
Finally by applying {\rlTermTyConv} to the equality obtained by
{\rlEqTyWeakNat}, we can conclude
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{\var{0}}{\sbshift{\G}{\A}{\sbs}}}
  {\subst{(\subst{\A}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.

% ENDS WITH TermVarZero
% ENDS WITH TermTyConv


\subsubsection*{Rule {\rlEqSubstShiftSucc}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstShiftSucc
\end{equation*}
%
From {\rlTySubst} and {\rlCtxExtend} we get $\istype{\G}{\subst{\A}{\sbs}}$ and
then $\isctx{(\ctxextend{\G}{\subst{\A}{\sbs}})}$.
%
By induction hypothesis on the middle premise, $\istype{\D}{\B}$,
then using {\rlTySubst} twice with subsitutions given in the left premise and
by {\rlSubstWeak} we derive
$\istype
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{(\subst{\B}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.
%
By successive applications of {\rlTermSubst} on the same substitutions we
conclude
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{(\subst{\var{k}}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
  {\subst{(\subst{\B}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.
%
For the last one, we use {\rlTermVarSucc} to get
$\isterm{\ctxextend{\D}{\A}}{\var{k+1}}{\subst{\B}{\sbweak{\D}{\A}}}$
and then with {\rlSubstShift} and {\rlTermSubst} we obtain
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{\var{k+1}}{\sbshift{\G}{\A}{\sbs}}}
  {\subst{(\subst{\B}{\sbweak{\D}{\A}})}{\sbshift{\G}{\A}{\sbs}}}
$.
Finally, by an application of {\rlTermTyConv} and {\rlEqTyWeakNat}, we conclude
$\isterm
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\subst{\var{k+1}}{\sbshift{\G}{\A}{\sbs}}}
  {\subst{(\subst{\B}{\sbs})}{\sbweak{\G}{\subst{\A}{\sbs}}}}
$.

% ENDS WITH TermSubst
% ENDS WITH TermTyConv


\subsubsection*{Rule {\rlEqSubstAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstAbs
\end{equation*}
%
We first get $\isctx{\G}$ by induction hypothesis on the left premise.
%
We then conclude
$\istype{\G}{\Prod{\subst{\A}{\sbs}} \subst{\B}{\sbshift{\G}{\A}{\sbs}}}$
using {\rlTermSubst} twice (once with {\rlSubstShift}) and then applying
{\rlTyProd}.
%
We use {\rlTermAbs} and {\rlTermSubst} to establish
%
$\isterm{\G} {\subst{(\lam{\A}{\B} \uu)}{\sbs}} {\subst{(\Prod{\A} \B)}{\sbs}}$.
We continue by applying {\rlTermTyConv}, with the equation that is yielded by
{\rlEqTySubstProd} to conclude
$\isterm{\G}
  {\subst{(\lam{\A}{\B} \uu)}{\sbs}}
  {\Prod
    {\subst{\A}{\sbs}}
    {\subst{\B}{\sbshift{\G}{\A}{\sbs}}}
  }
$.
By {\rlSubstShift} we get
$\issubst
  {(\sbshift{\G}{\A}{\sbs})}
  {\ctxextend{\G}{\subst{\A}{\sbs}}}
  {\ctxextend{\D}{\A}}
$, which allows us to form
$\isterm
 {\ctxextend{\G}{\subst{\A}{\sbs}}}
 {\subst{\uu}{\sbshift{\sbs}{\G}{\A}}}
 {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}
$
by {\rlTermSubst}. We conclude by an application of {\rlTermAbs}.

% ENDS WITH IH Contexts
% ENDS WITH TermSubst
% ENDS WITH TermAbs

\subsubsection*{Rule {\rlEqSubstApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstApp
\end{equation*}
%
We first get $\isctx{\G}$ by induction hypothesis on the left premise.
%
From an application of {\rlSubstZero} to the last premise we get
$\issubst{\sbzero{\D}{\A}{\vv}}{\D}{\ctxextend{\D}{\A}}$
and then using {\rlTySubst} twice on the second premise yields
$\istype{\D}{\subst{\B}{\sbzero{\D}{\A}{\vv}}}$ and
$\istype{\G}{\subst{(\subst{\B}{\sbzero{\D}{\A}{\vv}})}{\sbs}}$.
%
An application of {\rlTermApp} on the last three premises followed by
{\rlTermSubst} gives us
$\isterm{\G}
  {\subst{(\app{\uu}{\A}{\B}{\vv})}{\sbs}}
  {\subst{(\subst{\B}{\sbzero{\D}{\A}{\vv}})}{\sbs}}
$.
%
If we use {\rlTermSubst} and {\rlTySubst} as well as {\rlSubstShift}
and {\rlEqTySubstProd} before applying {\rlTermApp} we get
$\isterm{\G}
  {\app
    {\subst{\uu}{\sbs}}
    {\subst{\A}{\sbs}}
    {\subst
      {\B}
      {\sbshift{\G}{\A}{\sbs}}
    }
    {\subst{\vv}{\sbs}}}
  {\subst
    {\subst
      {\B}
      {\sbshift{\G}{\A}{\sbs}}}
    {\sbzero{\G}{\subst{\A}{\sbs}}{\subst{\vv}{\sbs}}}}
$.
Now using {\rlEqTyShiftZero} and {\rlTermTyConv} we conclude
$\isterm{\G}
  {\app
    {\subst{\uu}{\sbs}}
    {\subst{\A}{\sbs}}
    {\subst
      {\B}
      {\sbshift{\G}{\A}{\sbs}}
    }
    {\subst{\vv}{\sbs}}}
  {\subst{(\subst{\B}{\sbzero{\D}{\A}{\vv}})}{\sbs}}
$.

% ENDS WITH IH Contexts
% ENDS WITH TermSubst
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlEqSubstRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstRefl
\end{equation*}
%
We first get $\isctx{\G}$ by induction hypothesis on the left premise.
%
Then by induction hypothesis on the right premise we get $\istype{\D}{\A}$
and then an application of {\rlTySubst} and two applications of
{\rlTermSubst} followed by {\rlTyId} yield
$\istype{\G}{\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\uu}{\sbs}}}$.
%
In the same fashion, but using {\rlTermRefl} instead we get
$\isterm{\G}
  {\refl{\subst{\A}{\sbs}} \subst{\uu}{\sbs}}
  {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\uu}{\sbs}}}
$.
%
If we begin with {\rlTermRefl} and then apply {\rlTermSubst}, we obtain
the last judgment up to {\rlEqTySubstId} (which we apply with {\rlTermTyConv})
$\isterm{\G}
  {\subst{\refl{\A} \uu}{\sbs}}
  {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\uu}{\sbs}}}
$.

% ENDS WITH IH Contexts
% ENDS WITH TermRefl
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlEqReflection}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqReflection
\end{equation*}
%
We get $\isctx{\G}$ by induction hypothesis on the left premise.
%
The rest we obtain by inversion~\ref{pbm:id-inversion}.

% ENDS WITH IH Contexts
% ENDS WITH Inversion Types
% ENDS WITH Inversion Terms

\subsubsection*{Rule {\rlProdBeta}}

Consider a derivation ending with
%
\begin{equation*}
  \showProdBeta
\end{equation*}
%
We get $\isctx{\G}$ and $\istype{\ctxextend{\G}{\A}}{\B}$ by induction
hypothesis on the left premise, and $\istype{\G}{\A}$ by induction hypothesis
on the right premise.
%
From {\rlSubstZero} and {\rlTySubst} we get
$\istype{\G}{\subst{\B}{\sbzero{\G}{\A}{\vv}}}$.
%
In a similar fashion using {\rlTermSubst} we get
$\isterm{\G}
  {\subst{\uu}{\sbzero{\G}{\A}{\vv}}}
  {\subst{\B}{\sbzero{\G}{\A}{\vv}}}
$.
%
By an application of {\rlTermAbs}, we get
$\isterm{\G}{\lam{\A}{\B}{\uu}}{\Prod{\A} \B}$,
then, by an application of {\rlTermApp} we conclude
$\isterm{\G}
  {\app{(\lam{\A}{\B}{\uu})}{\A}{\B}{\vv}}
  {\subst{\B}{\sbzero{\G}{\A}{\vv}}}
$.

% ENDS WITH IH Contexts
% ENDS WITH TermApp
% ENDS WITH TermSubst

\subsubsection*{Rule {\rlProdEta}}

Consider a derivation ending with
%
\begin{equation*}
  \showProdEta
\end{equation*}
%
By induction hypothesis on the left premise we immediately conclude
$\isctx{\G}$ and $\istype{\G}{\Prod{\A} \B}$.
Then
$\isterm{\G}{\uu}{\Prod{\A} \B}$ and
$\isterm{\G}{\vv}{\Prod{\A} \B}$ are just the premises.

% ENDS WITH IH Contexts
% ENDS WITH IH Types
% ENDS WITH Premise Terms

\subsubsection*{Rule {\rlCongAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongAbs
\end{equation*}
%
By the different induction hypotheses we get $\isctx{\G}$,
$\istype{\G}{\A_1}$, $\istype{\ctxextend{\G}{\A_1}}{\A_2}$,
$\isterm{\ctxextend{\G}{\A_1}}{\uu_1}{\A_2}$,
$\istype{\G}{\B_1}$ and, up to {\rlTyCtxConv}, {\rlTermCtxConv} and
{\rlEqCtxExtend},
$\istype{\ctxextend{\G}{\B_1}}{\B_2}$ and
$\isterm{\ctxextend{\G}{\B_1}}{\uu_2}{\B_2}$.
%
By an application of {\rlTyProd} we obtain $\istype{\G}{\Prod{\A_1} \A_2}$.
By applications of {\rlTermApp} we obtain
$\isterm{\G}{\lam{\A_1}{\A_2}{\uu_1}}{\Prod{\A_1} \A_2}$ and
$\isterm{\G}{\lam{\B_1}{\B_2}{\uu_2}}{\Prod{\B_1} \B_2}$.
Finally, with {\rlCongProd} and {\rlTermTyConv} we conclude
$\isterm{\G}{\lam{\B_1}{\B_2}{\uu_2}}{\Prod{\A_1} \A_2}$.

% ENDS WITH IH Contexts
% ENDS WITH TermApp
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlCongApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongApp
\end{equation*}
%
By induction hypothesis, we get $\isctx{\G}$,
$\istype{\G}{\A_1}$, $\istype{\ctxextend{\G}{\A_1}}{\A_2}$,
$\isterm{\G}{\uu_1}{\Prod{\A_1} \A_2}$,
$\isterm{\ctxextend{\G}{\A_1}}{\uu_2}{\A_2}$ and, with a touch of
{\rlEqCtxExtend}, {\rlTyCtxConv}, {\rlCongProd} and {\rlTermTyConv},
$\istype{\G}{\B_1}$, $\istype{\ctxextend{\G}{\B_1}}{\B_2}$,
$\isterm{\G}{\vv_1}{\Prod{\B_1} \B_2}$,
$\isterm{\ctxextend{\G}{\B_1}}{\vv_2}{\B_2}$.
From all this we derive, using {\rlTermApp},
$\isterm{\G}
  {\app{\uu_1}{\A_1}{\A_2}{\uu_2}}
  {\subst{\A_2}{\sbzero{\G}{\A_1}{\uu_1}}}
$ and
$\isterm{\G}
  {\app{\vv_1}{\B_1}{\B_2}{\vv_2}}
  {\subst{\B_2}{\sbzero{\G}{\B_1}{\vv_1}}}
$.
Now using {\rlEqTyCongZero}, {\rlEqTySym} and {\rlTermTyConv} we conclude
$\isterm{\G}
  {\app{\vv_1}{\B_1}{\B_2}{\vv_2}}
  {\subst{\A_2}{\sbzero{\G}{\A_1}{\uu_1}}}
$

% ENDS WITH IH Contexts
% ENDS WITH TermApp
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlCongRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongRefl
\end{equation*}
%
By induction hypotheses, we get $\isctx{\G}$, $\istype{\G}{\A_1}$,
$\istype{\G}{\A_2}$, $\isterm{\G}{\uu_1}{\A_1}$ and
$\isterm{\G}{\uu_2}{\A_1}$. Using {\rlTermTyConv} we obtain
$\isterm{\G}{\uu_2}{\A_2}$.
By an application of {\rlTyId} we derive $\istype{\G}{\Id{\A_1}{\uu_1}{\uu_1}}$.
By applications of {\rlTermRefl} we derive
$\isterm{\G}{\refl{\A_1} \uu_1}{\Id{\A_1}{\uu_1}{\uu_1}}$ and
$\isterm{\G}{\refl{\A_2} \uu_2}{\Id{\A_2}{\uu_2}{\uu_2}}$.
Finally, using {\rlCongId} and {\rlTermTyConv} we conclude
$\isterm{\G}{\refl{\A_2} \uu_2}{\Id{\A_1}{\uu_1}{\uu_1}}$.

% ENDS WITH IH Contexts
% ENDS WITH TermRefl
% ENDS WITH TermTyConv

\subsubsection*{Rule {\rlCongTermSubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongTermSubst
\end{equation*}
%
By induction hypothesis on the left premise we conclude $\isctx{\G}$.
%
By induction hypothesis on the right premise we get $\istype{\D}{\A}$,
$\isterm{\D}{\uu_1}{\A}$ and $\isterm{\D}{\uu_2}{\A}$.
By an application of {\rlTySubst} we conclude $\istype{\G}{\subst{\A}{\sbs}}$.
By applications of {\rlTermSubst} we finally conclude
$\isterm{\G}{\subst{\uu_1}{\sbs}}{\subst{\A}{\sbs}}$ and
$\isterm{\G}{\subst{\uu_2}{\sbs}}{\subst{\A}{\sbs}}$.

% ENDS WITH IH Contexts
% ENDS WITH TermSubst
% ENDS WITH TySubst

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
