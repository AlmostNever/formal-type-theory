\section{Type theory is well formed}
\label{sec:type-theory-well}

\begin{theorem}
  Type theory is well formed in the following sense:
  %
  \begin{enumerate}
  \item \label{sane-issubst} if $\issubst{\sbs}{\G}{\D}$ then $\isctx{\G}$ and $\isctx{\D}$,
  \item \label{sane-istype}  if $\istype{\G}{\A}$ then $\isctx{\G}$,
  \item \label{sane-isterm}  if $\isterm{\G}{\uu}{\A}$ then $\istype{\G}{\A}$,
  \item \label{sane-eqctx}   if $\eqctx{\G}{\D}$ then $\isctx{\G}$ and $\isctx{\D}$,
  \item \label{sane-eqtype}  if $\eqtype{\G}{\A}{\B}$ then $\istype{\G}{\A}$ and $\istype{\G}{\B}$,
  \item \label{sane-eqterm}  if $\eqterm{\G}{\uu}{\vv}{\A}$ then $\isterm{\G}{\uu}{\A}$ and $\isterm{\G}{\vv}{\A}$.
  \end{enumerate}
\end{theorem}

The rest of this section contains the proof, which proceeds by structural induction on the
derivation.

\subsection{Contexts \fbox{$\isctx{\G}$}}

\subsubsection*{Rule {\rlCtxEmpty}}

We need not consider this rule.
% But do not delete this without understanding what verify.sh does.

\subsubsection*{Rule {\rlCtxExtend}}

We need not consider this rule.
% But do not delete this without understanding what verify.sh does.

\subsection{Substitutions \fbox{$\issubst{\sbs}{\G}{\D}$}}

This section proves clause \eqref{sane-issubst} of the theorem.


\subsubsection*{Rule {\rlSubstZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstZero
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlSubstWeak}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstWeak
\end{equation*}
%
First, $\isctx{\G}$ follows by induction hypothesis on the premise, and then
$\isctx{\ctxextend{\G}{\A}}$ by an application of {\rlCtxExtend}.


\subsubsection*{Rule {\rlSubstShift}}

Consider a derivation ending with
%
\begin{equation*}
  \showSubstShift
\end{equation*}
%
\meta{TO DO}

\subsection{Types \fbox{$\istype{\G}{\A}$}}

In this section we prove clause \eqref{sane-istype}.

\subsubsection*{Rule {\rlTyCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyCtxConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\isctx{\D}$.

\subsubsection*{Rule {\rlTySubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showTySubst
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsubsection*{Rule {\rlTyProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyProd
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsubsection*{Rule {\rlTyId}}

Consider a derivation ending with
%
\begin{equation*}
  \showTyId
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isctx{\G}$.

\subsection{Terms \fbox{$\isterm{\G}{\uu}{\A}$}}

In this section we prove clause \eqref{sane-isterm}.

\subsubsection*{Rule {\rlTermTyConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermTyConv
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\G}{\B}$.


\subsubsection*{Rule {\rlTermCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermCtxConv
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$, and then we apply
{\rlTyCtxConv} using the right premise.


\subsubsection*{Rule {\rlTermSubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermSubst
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\D}{\A}$, and then we
apply {\rlTySubst} using the left premise.

\subsubsection*{Rule {\rlTermVar}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermVar
\end{equation*}
%
We apply {\rlSubstWeak} to the premise to obtain
$\issubst{\sbweak{\G}{\A}}{\ctxextend{\G}{\A}}{\G}$. Then we apply {\rlTySubst} to it
and to the premise.

\subsubsection*{Rule {\rlTermVarSkip}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermVarSkip
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$. We
apply {\rlTySubst} to it and to {\rlSubstWeak} applied to the
right premise.


\subsubsection*{Rule {\rlTermAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermAbs
\end{equation*}
%
By induction hypothesis on the right premise we obtain $\istype{\ctxextend{\G}{\A}}{\B}$,
after which we apply {\rlTyProd} to it and to the left premise.


\subsubsection*{Rule {\rlTermApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermApp
\end{equation*}
%
% We first argue that we may apply {\rlSubstExtend} as follows:
% %
% \begin{equation*}
%   \inferrule*
%   {
%    \inferrule*{\isctx{\G}}{\issubst{\sbid{\G}}{\G}{\G}}
%    \\
%    \istype{\G}{\A} \\
%    \inferrule*
%       {\isterm{\G}{\vv}{\A} \\
%        \eqtype{\G}{\A}{\subst{\A}{\sbid{\G}}}
%       }
%       {\isterm{\G}{\vv}{\subst{\A}{\sbid{\G}}}}
%   }
%   {\issubst
%    {(\sbextend{\sbid{\G}}{\A}{\vv})}
%    {\G}
%    {\ctxextend{\G}{\A}}
%   }
% \end{equation*}
% %
% The left premise of this derivation follows by \meta{BROKEN:CtxId}, which in turn is
% justified by \meta{\{something missing: several solutions like strengthening
% the theorem/program, adding $\istype{\G}{\A}$ as a premise to {\rlTermApp} or
% devise a way to call the induction hypothesis on its result. \}}

\subsubsection*{Rule {\rlTermRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermRefl
\end{equation*}
%
By induction hypothesis on the premise we obtain $\istype{\G}{\A}$
and then by using {\rlTyId} on it and on the premise itself twice,
we conclude $\istype{\G}{\Id{\A}{\uu}{\uu}}$.

\subsection{Context equality \fbox{$\eqctx{\G}{\D}$}}

In this section we prove clause~\eqref{sane-eqctx}.

\subsubsection*{Rule {\rlEqCtxEmpty}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxEmpty
\end{equation*}
%
By {\rlCtxEmpty}, $\isctx{\ctxempty}$ holds.

\subsubsection*{Rule {\rlEqCtxExtend}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxExtend
\end{equation*}
%
We apply {\rlCtxExtend} twice to the induction hypotheses to conclude
$\isctx{\ctxextend{\G}{\A}}$ and $\isctx{\ctxextend{\D}{\B}}$.


\subsection{Type equality \fbox{$\eqtype{\G}{\A}{\B}$}}

In this section we prove clause~\eqref{sane-eqtype}.

\subsubsection*{Rule {\rlEqTyCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyCtxConv
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\istype{\G}{\A}$
and $\istype{\G}{\B}$.
Using {\rlTyCtxConv} on both combined with the right premise we obtain
$\istype{\D}{\A}$ and $\istype{\D}{\B}$.

\subsubsection*{Rule {\rlEqTyRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyRefl
\end{equation*}
%
We have $\istype{\G}{\A}$ as premise.

\subsubsection*{Rule {\rlEqTySym}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySym
\end{equation*}
%
By induction hypothesis on the premise, we conclude.

\subsubsection*{Rule {\rlEqTyTrans}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyTrans
\end{equation*}
%
By induction hypothesis on the premises, we conclude.


\subsubsection*{Rule {\rlEqTyWeakNat}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyWeakNat
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlEqTySubstProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySubstProd
\end{equation*}
%
Using {\rlTyProd} and {\rlTySubst} we get
$\istype{\G}{\subst{(\Prod{\A}{\B})}{\sbs}}$.
An application of {\rlTySubst} yields $\istype{\G}{\subst{\A}{\sbs}}$
and a slightly more complicated one
$\istype{\ctxextend{\G}{\subst{\A}{\sbs}}}{\subst{\B}{\sbshift{\sbs}{\G}{\A}}}$.
We now apply {\rlTyProd} to conclude
$\istype
  {\G}
  {\Prod
    {\subst{\A}{\sbs}}
    {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}}$.

\subsubsection*{Rule {\rlEqTySubstId}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTySubstId
\end{equation*}
%
We apply {\rlTyId} and {\rlTySubst} to the premises to get
$\istype{\G}{\subst{(\Id{\A}{\uu}{\vv})}{\sbs}}$. Then we apply {\rlTySubst} and
{\rlTermSubst} on the last three premises and put the results together using
{\rlTyId} to get
$\istype{\G}{\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\vv}{\sbs}}}$.

\subsubsection*{Rule {\rlCongProd}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongProd
\end{equation*}
%
The induction hypotheses yield $\istype{\G}{\A_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\A_2}$, as well as $\istype{\G}{\B_1}$ and
$\istype{\ctxextend{\G}{\A_1}}{\B_2}$. We may conclude $\istype{\G}{\Prod{A_1} A_2}$ and
$\istype{\G}{\Prod{B_1} B_2}$ by {\rlTyProd}, provided we derive
$\istype{\ctxextend{\G}{\B_1}}{\B_2}$. To do so, we first derive
$\eqctx{\ctxextend{\G}{\A_1}}{\ctxextend{\G}{\B_1}}$ by {\rlEqCtxExtend} and then
apply {\rlTyCtxConv} to $\istype{\ctxextend{\G}{\A_1}}{\B_2}$.

\subsubsection*{Rule {\rlCongId}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongId
\end{equation*}
%
We apply {\rlTyId} to the induction hypotheses to get
$\istype{\G}{\Id{\A}{\uu_1}{\uu_2}}$. We obtain $\istype{\G}{\Id{\B}{\vv_1}{\vv_2}}$ in
the same way, but use {\rlTermTyConv} on the last two induction hypotheses beforehand.

\subsubsection*{Rule {\rlCongTySubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongTySubst
\end{equation*}
%
We apply {\rlTySubst} on the left premise and the induction hypothesis
applied to the right premise to conclude.

\goodbreak

\subsection{Term equality \fbox{$\eqterm{\G}{\uu_1}{\uu_2}{\A}$}}

This section proves clause \eqref{sane-eqterm}.



\subsubsection*{Rule {\rlEqTyConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTyConv
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isterm{\G}{\uu}{\A}$
and $\isterm{\G}{\vv}{\A}$. Then using {\rlTermTyConv} on both and on the
right premise, we conclude $\isterm{\G}{\uu}{\B}$ and $\isterm{\G}{\vv}{\B}$.

\subsubsection*{Rule {\rlEqCtxConv}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqCtxConv
\end{equation*}
%
By induction hypothesis on the left premise we obtain $\isterm{\G}{\uu}{\A}$
and $\isterm{\G}{\vv}{\A}$. Then using {\rlTermCtxConv} on both and on the
right premise, we conclude $\isterm{\D}{\uu}{\A}$ and $\isterm{\D}{\vv}{\A}$.

\subsubsection*{Rule {\rlEqRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqRefl
\end{equation*}
%
We have $\isterm{\G}{\uu}{\A}$ as a premise.

\subsubsection*{Rule {\rlEqSym}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSym
\end{equation*}
%
We conclude immediately using the induction hypothesis.

\subsubsection*{Rule {\rlEqTrans}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqTrans
\end{equation*}
%
We conclude immediately using the induction hypotheses.




\subsubsection*{Rule {\rlEqSubstWeak}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstWeak
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlEqSubstZeroZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstZeroZero
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlEqSubstZeroSucc}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstZeroSucc
\end{equation*}
%
\meta{TO DO}



\subsubsection*{Rule {\rlEqSubstShiftZero}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstShiftZero
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlEqSubstShiftSucc}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstShiftSucc
\end{equation*}
%
\meta{TO DO}


\subsubsection*{Rule {\rlEqSubstAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstAbs
\end{equation*}
%
We use {\rlTermAbs} and {\rlTermSubst} to establish
%
$\isterm{\G} {\subst{(\lam{\A}{\B} \uu)}{\sbs}} {\subst{(\Prod{\A} \B)}{\sbs}} $. We
continue with {\rlTermTyConv}, using the equation given by {\rlEqTySubstProd} to conclude
$\isterm{\G} {\subst{(\lam{\A}{\B} \uu)}{\sbs}} {\Prod {\subst{\A}{\sbs}} {\subst {\B}
    {\sbshift{\sbs}{\G}{\A}} } } $. Observe that by {\rlTySubst} we have
$\istype{\G}{\subst{\A}{\sbs}}$. By {\rlSubstShift} we get
$\issubst{\sbshift{\sbs}{\G}{\A}}{\ctxextend{\G}{\subst{\A}{\sbs}}}{\ctxextend{\D}{\A}}$,
  which allows us to form
$\isterm
 {\ctxextend{\G}{\subst{\A}{\sbs}}}
 {\subst{\uu}{\sbshift{\sbs}{\G}{\A}}}
 {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}
$
by {\rlTermSubst}. We conclude by an application of {\rlTermAbs}.


\subsubsection*{Rule {\rlEqSubstApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstApp
\end{equation*}

\subsubsection*{Rule {\rlEqSubstRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqSubstRefl
\end{equation*}

\subsubsection*{Rule {\rlEqReflection}}

Consider a derivation ending with
%
\begin{equation*}
  \showEqReflection
\end{equation*}


\subsubsection*{Rule {\rlProdBeta}}

Consider a derivation ending with
%
\begin{equation*}
  \showProdBeta
\end{equation*}

\subsubsection*{Rule {\rlProdEta}}

Consider a derivation ending with
%
\begin{equation*}
  \showProdEta
\end{equation*}

\subsubsection*{Rule {\rlCongAbs}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongAbs
\end{equation*}

\subsubsection*{Rule {\rlCongApp}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongApp
\end{equation*}

\subsubsection*{Rule {\rlCongRefl}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongRefl
\end{equation*}

\subsubsection*{Rule {\rlCongTermSubst}}

Consider a derivation ending with
%
\begin{equation*}
  \showCongTermSubst
\end{equation*}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
