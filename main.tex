\documentclass{amsart}

\usepackage[utf8]{inputenc}
\usepackage{times}
\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{amsthm}
\usepackage{hyperref}

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

\newtheorem{theorem}{Theorem}[section]

\begin{document}

\title{Reflection in MLTT}

\author{Andrej Bauer}
\address{Andrej Bauer\\University of Ljubljana\\Slovenia}
\email{Andrej.Bauer@andrej.com}

\author{Théo Winterhalter}
\address{Théo Winterhalter\\École normale supérieure de Cachan\\France}
\email{theo.winterhalter@gmail.com}

\begin{abstract}
  We verify that we can translate from MLTT + reflection to MLTT (or something).
\end{abstract}

\maketitle

\section{MLTT Rules}

We use MLTT with $\Pi$-types and identity types (we can later add either UIP
or the $\J$ eliminator) presented in a bidirectionnal typing fashion.

\paradot{Context Wellformedness}

\begin{mathc}
  \ru{}{\der \cdot}
  \qquad
  \ru{\Gamma \der T\ \type \qquad
      x \notin \Gamma
    }{\der \Gamma, x : T}
  \qquad
  \ru{\der \Gamma \qquad
      (x : T) \in \Gamma
    }{\Gamma \der x : T}
\end{mathc}

\paradot{Type formation}

\begin{mathc}
  \ru{\Gamma \der T\ \type \qquad
      \Gamma \der t,t' : T
    }{\Gamma \der \Id{T}{t}{t'}\ \type}
  \qquad
  \ru{\Gamma \der A\ \type \qquad
      \Gamma, x:A \der B\ \type
    }{\Gamma \der \Pi x:A.B\ \type}
\end{mathc}

\paradot{Term Typing}

\begin{mathc}
  \ru{\Gamma \der \Pi x:A.B\ \type \qquad
      \Gamma, x:A \der t \checks B
    }{\Gamma \der \lambda (x:A.B).t \infers \Pi x:A.B}
  \qquad
  \ru{\Gamma \der t \checks \Pi x:A.B \qquad
      \Gamma \der t' \checks A
    }{\Gamma \der \app{x:A.B}{t}{t'} \infers B[t'/x]}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t \checks T
    }{\Gamma \der \refl_t \infers \Id{T}{t}{t}}
  \qquad
  \ru{\Gamma \der t \infers A \qquad
      \Gamma \der B\ \type \qquad
      \Gamma \der A \equiv B
    }{\Gamma \der t \checks B}
\end{mathc}

\paradot{Judgmental Equality}

\begin{mathc}
  \ru{\Gamma, x:U \der t:V \qquad
      \Gamma \der u : U
    }{\Gamma \der \app{x:U.V}{(\lambda (x:U.V).t)}{u} = t[u/x] : V[u/x]}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t : \Pi x:U.V
    }{\Gamma \der t \equiv \lambda (x:U.V).\app{x:U.V}{t}{x} : \Pi x:U.V}
\end{mathc}
%
And so on... (Should we use $t : T$, $t \infers T$ or $t \checks T$?)
(Actually, it is not an algorithm so... Remark: It could be turned into one
by simply asking for reflection when all else fails.)

To get the extensional MLTT we simply add the following reflection rule.
%
\begin{mathc}
  \ru{\Gamma \der p : \Id{T}{t}{t'}
    }{\Gamma \der t \equiv t' : T}
\end{mathc}


\section{The Theorem we Want to Prove}

Should the theorem be like:

\begin{theorem}
  If $\Gamma \dere t : T$, then there exists
  $\der \barG \in \den{\dere \Gamma}$ and for any such $\barG$ there exists
  $\barT$ such that $\barG \der \barT\ \type \in \den{\Gamma \dere T}$
  and for any such $\barT$ there exists $\bart$ such that
  $\barG \der \bart : \barT \in \den{\Gamma \dere t : T}$.
\end{theorem}
%
Where we have yet to define the translations sets $\den{\_}$.
We also have to tell explicitely how the theorem works on other judgments.
\meta{Also, we could use the bidirectionality for something...}

\begin{proof}
  By induction on the derivation.
  \begin{caselist}
    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere A\ \type \qquad
          \Gamma, x:A \dere B\ \type
        }{\Gamma \dere \Pi x:A.B\ \type}
    \end{mathc}
    \meta{Assuming} context extension and translation commute, it works.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere T\ \type \qquad
          \Gamma \dere t,t' : T
        }{\Gamma \dere \Id{T}{t}{t'}\ \type}
    \end{mathc}
    Same here.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere \Pi x:A.B\ \type \qquad
          \Gamma, x:A \dere t \checks B
        }{\Gamma \dere \lambda (x:A.B).t \infers \Pi x:A.B}
    \end{mathc}
    By first induction hypothesis, we have $\der \barG \in \den{\dere \Gamma}$.
    Now given such $\barG$, using the same induction hypothesis we have
    $\barG \der \Pi x:\barA.\barB\ \type
    \in \den{\Gamma \dere \Pi x:A.B\ \type}$
    (\meta{assuming} translation of types preserves shapes).
    Now given such $\Pi x:\barA.\barB$, we in particular have
    $\barG \der \barA\ \type \in \den{\Gamma \dere A\ \type}$
    (\meta{assuming} we have some ind of inversion linked with the previous
    assumption). The same goes for $\barB$.

    Now, we have $\der \barG, x:\barA \in \den{\dere \Gamma, x:A}$.
    Thus by second induction hypothesis with our choice of $\barA$ and
    $\barB$, we have $\bart$ such that
    $\barG, x:\barA \der \bart \checks \barB \in
    \den{\Gamma, x:A \dere t \checks B}$.
    Thus $\barG \der \lambda (x:\barA.\barB).\bart \infers \Pi x:\barA.\barB
    \in \den{\Gamma \dere \lambda (x:A.B).t \infers \Pi x:A.B}$.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \checks \Pi x:A.B \qquad
          \Gamma \dere u \checks A
        }{\Gamma \dere \app{x:A.B}{t}{u} \infers B[u/x]}
    \end{mathc}
    \meta{What liberty do we have in providing a translation of $B[u/x]$? The
    ideal would that it has to be of the form $\barB[\baru/x]$.}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \checks T
        }{\Gamma \dere \refl_t \infers \Id{T}{t}{t}}
    \end{mathc}
    It seems to work under the same \meta{assumptions} as before (commutation
    between context extension and translation ; inversion of translation of
    types).

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \infers A \qquad
          \Gamma \dere B\ \type \qquad
          \Gamma \dere A \equiv B
        }{\Gamma \dere t \checks B}
    \end{mathc}
    \meta{We need to know how to translate equalities to conclude...}
  \end{caselist}
\end{proof}

\meta{Just an idea like that: Why not translating to OTT instead of ITT? This
way, it might reveal clearer what is an irrelevant equality since they would
compute more...}

\end{document}
