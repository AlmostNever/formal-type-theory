\documentclass{amsart}

\usepackage[utf8]{inputenc}
\usepackage{times}
\usepackage{amsmath, amssymb, amsfonts, stmaryrd}
\usepackage{amsthm}
\usepackage{hyperref}

% Add some colors
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\hypersetup{
 linktocpage,
 colorlinks,
 citecolor=BlueViolet,
 filecolor=red,
 linkcolor=Blue,
 urlcolor=BrickRed
}

% Meta comment
\newcommand\meta[1]{\noindent\textcolor{blue}{\emph{#1}}}

% Include the macro file
\input{macros}

\newtheorem{theorem}{Theorem}[section]

\begin{document}

\title{Reflection in MLTT}

\author{Andrej Bauer}
\address{Andrej Bauer\\University of Ljubljana\\Slovenia}
\email{Andrej.Bauer@andrej.com}

\author{Théo Winterhalter}
\address{Théo Winterhalter\\ENS Cachan, Université Paris-Saclay\\France}
\email{theo.winterhalter@gmail.com}

\begin{abstract}
  We verify that we can translate from MLTT + reflection to MLTT (or something).
\end{abstract}

\maketitle

\section{MLTT Rules}

We use MLTT with $\Pi$-types and identity types (we can later add either UIP
or the $\J$ eliminator) presented in a bidirectionnal typing fashion.

\paradot{Context Wellformedness}

\begin{mathc}
  \ru{}{\der \cdot}
  \qquad
  \ru{\Gamma \der T\ \type \qquad
      x \notin \Gamma
    }{\der \Gamma, x : T}
  \qquad
  \ru{\der \Gamma \qquad
      (x : T) \in \Gamma
    }{\Gamma \der x : T}
\end{mathc}

\paradot{Type formation}

\begin{mathc}
  \ru{\Gamma \der T\ \type \qquad
      \Gamma \der t,t' \checks T
    }{\Gamma \der \Id{T}{t}{t'}\ \type}
  \qquad
  \ru{\Gamma \der A\ \type \qquad
      \Gamma, x:A \der B\ \type
    }{\Gamma \der \Pi x:A.B\ \type}
\end{mathc}

\paradot{Term Typing}

\begin{mathc}
  \ru{\Gamma \der \Pi x:A.B\ \type \qquad
      \Gamma, x:A \der t \checks B
    }{\Gamma \der \lambda (x:A.B).t \infers \Pi x:A.B}
  \qquad
  \ru{\Gamma \der t \checks \Pi x:A.B \qquad
      \Gamma \der t' \checks A
    }{\Gamma \der \app{x:A.B}{t}{t'} \infers B[t'/x]}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t \checks T
    }{\Gamma \der \refl_t \infers \Id{T}{t}{t}}
  \qquad
  \ru{\Gamma \der t \infers A \qquad
      \Gamma \der B\ \type \qquad
      \Gamma \der A \equiv B
    }{\Gamma \der t \checks B}
\end{mathc}

\paradot{Judgmental Equality}

\begin{mathc}
  \ru{\Gamma, x:U \der t:V \qquad
      \Gamma \der u : U
    }{\Gamma \der \app{x:U.V}{(\lambda (x:U.V).t)}{u} \equiv t[u/x] : V[u/x]}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t : \Pi x:U.V
    }{\Gamma \der t \equiv \lambda (x:U.V).\app{x:U.V}{t}{x} : \Pi x:U.V}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t : T
    }{\Gamma \der t \equiv t : T}
  \qquad
  \ru{\Gamma \der t' \equiv t : T
    }{\Gamma \der t \equiv t' : T}
  \qquad
  \ru{\Gamma \der t_1 \equiv t_2 : T \qquad
      \Gamma \der t_2 \equiv t_3 : T
    }{\Gamma \der t_1 \equiv t_3 : T}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der T\ \type
    }{\Gamma \der T \equiv T}
  \qquad
  \ru{\Gamma \der T' \equiv T
    }{\Gamma \der T \equiv T'}
  \qquad
  \ru{\Gamma \der T_1 \equiv T_2 \qquad
      \Gamma \der T_2 \equiv T_3
    }{\Gamma \der T_1 \equiv T_3}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der U \equiv U' \qquad
     \Gamma, x:U \der V \equiv V'
   }{\Gamma \der \Pi x:U.V \equiv \Pi x:U'.V'}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der U \equiv U' \qquad
      \Gamma, x:U \der V\ \type \qquad
      \Gamma, x:U \der t \equiv t' : V
    }{\Gamma \der \lambda (x:U.V).t \equiv \lambda (x:U'.V').t' : \Pi x:U.V}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t \equiv t' : \Pi x:U.V \qquad
      \Gamma \der u \equiv u' : U
    }{\Gamma \der \app{x:U.V}{t}{u} \equiv \app{x:U'.V'}{t'}{u'} : V[u/x]}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der T \equiv T' \qquad
      \Gamma \der t \equiv t' : T \qquad
      \Gamma \der u \equiv u' : T
    }{\Gamma \der \Id{T}{t}{u} \equiv \Id{T'}{t'}{u'}}
\end{mathc}

\begin{mathc}
  \ru{\Gamma \der t \equiv t' : T \qquad
    }{\Gamma \der \refl{t} \equiv \refl{t'} : \Id{T}{t}{t}}
\end{mathc}
%
And so on... (Should we use $t : T$, $t \infers T$ or $t \checks T$?)
(Actually, it is not an algorithm so... Remark: It could be turned into one
by simply asking for reflection when all else fails.)

To get the extensional MLTT we simply add the following reflection rule.
%
\begin{mathc}
  \ru{\Gamma \dere p : \Id{T}{t}{t'}
    }{\Gamma \dere t \equiv t' : T}
\end{mathc}


\section{The Theorem we Want to Prove}

The theorem could now be like.

\begin{theorem}
  \leavevmode
  \begin{enumerate}
    \item If $\Gamma \dere A\ \type$ then $\Gamma$ has a translation $\barG$,
    and for any such $\barG$, $A$ has a translation $\barA$ such that
    $\barG \der \barA\ \type$. Furthermore, if $\barA'$ is provided as another
    translation of $A$, we also get an isomporphism between $\barA$ and
    $\barA'$.
    \item If $\Gamma \dere t \infers T$ then $\Gamma$ has a translation $\barG$,
    and for any such $\barG$, $t$ and $T$ have translations $\bart$ and $\barT$
    such that $\barG \der \bart : \barT$. Besides, if $\barT'$ is another
    translation of $T$, we get an isomorphism between $\barT$ and $\barT'$.
    \item If $\Gamma \dere t \checks T$ then $\Gamma$ has a translation $\barG$,
    and for any such $\barG$ and a translation $\barT$ of $T$, we have a
    translation $\bart$ of $t$ such that $\barG \der \bart : \barT$.
    \item If $\Gamma \dere A \equiv B$ then $\Gamma$ has a translation $\barG$
    and for any such $\barG$ and $\barA$ translation of $A$ then $B$ as a
    translation $\barB$ such that $\barA$ and $\barB$ have an isomorphism in
    $\barG$.
    \item If $\Gamma \dere A \equiv B$ then $\Gamma$ has a translation $\barG$
    and for any such $\barG$ and $\barA$, $\barB$ translations of $A$ and $B$
    then $\barA$ and $\barB$ have an isomorphism in $\barG$.
    \item  If $\Gamma \dere u \equiv v : A$ then $\Gamma$ has a translation
    $\barG$ and for any such $\barG$ and $\barA$ translation of $A$ then we
    have $\barp$, $\baru$ and $\barv$ such that
    $\barG \der \barp : \Id{\barA}{\baru}{\barv}$.
  \end{enumerate}
\end{theorem}

\meta{Furthermore, the notion of \emph{translation} preserves the shape of
types.}

\begin{proof}
  By induction on the derivation.
  \meta{We will focus on the (hopefully) hard cases.}
  \begin{caselist}
    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere A\ \type \qquad
          \Gamma, x:A \dere B\ \type
        }{\Gamma \dere \Pi x:A.B\ \type}
    \end{mathc}
    By first induction hypothesis, we get a $\barG$ translation of $\Gamma$,
    now assume we take any such $\barG$.
    By first induction hypothesis again, we get $\barA$ such that
    $\barG \der \barA\ \type$.
    Now, $\barG, x:\barA$ is a valid translation of $\Gamma, x:A$ so,
    by second induction hypothesis, we get $\barB$ such that
    $\barG, x:\barA \der \barB\ \type$.
    From that we deduce $\barG \der \Pi x:\barA.\barB\ \type$ which is a valid
    translation of our goal.

    Finally, assume we are given a translation of $\Pi x:A.B$, by definition
    it has to be a $\Pi$-type as well. It is thus some $\Pi x:\barA'.\barB'$
    where $\barA'$ and $\barB'$ are respective translations of $A$ and $B$.
    By first induction hypothesis, we get $f$ an isomorphism between $\barA$
    and $\barA'$. By the second, we get $g$ an iso between $\barB$ and $\barB'$.
    As such,
    \begin{equation*}
    \lambda (e:(\Pi x:\barA.\barB).\Pi x:\barA'.\barB'). g \circ e \circ f^{-1}
    \end{equation*}
    is what we are looking for.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \der T\ \type \qquad
          \Gamma \der t,t' \checks T
        }{\Gamma \der \Id{T}{t}{t'}\ \type}
    \end{mathc}
    By IH1, we can translate the context and take such a $\barG$.
    By IH1, we also get $\barT$ a translation of $T$ such that
    $\barG \der \barT\ \type$.
    We can thus use IH2 and IH3 to get $\bart$ and $\bart'$ such that
    $\barG \der \bart, \bart' : \barT$.
    This way, we get $\barG \der \Id{\barT}{\bart}{\bart'}\ \type$.

    Now assume we are given a translation of $\Id{T}{t}{t'}$, this means that
    we are given some $\Id{\barT'}{\baru}{\barv}$.
    By IH1, we get an isomporphism between $\barT$ and $\barT'$.
    \meta{Now we need to know what we can deduce for the terms...}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \checks \Pi x:A.B \qquad
          \Gamma \dere u \checks A
        }{\Gamma \dere \app{x:A.B}{t}{u} \infers B[u/x]}
    \end{mathc}
    By first induction hypothesis we translate the context, and for any such
    translation $\barG$, \meta{we need to change the rule so that the premises
    can produce a translation of the types.}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \infers A \qquad
          \Gamma \dere B\ \type \qquad
          \Gamma \dere A \equiv B
        }{\Gamma \dere t \checks B}
    \end{mathc}
    By first induction hypothesis, we get $\barG$ as a translation of $\Gamma$
    and now assume any such $\barG$. Furthermore, we assume $\barB$ as a
    translation of $B$, we want a translation $\bart$ of $t$ such that
    $\barG \der \bart : \barB$.

    By first IH, we have $\bart$ and $\barA$ such that
    $\barG \der \bart : \barA$. Since $\Gamma \dere A \equiv B$, we have
    an isomorphism $f$ in $\barG$ between $\barA$ and $\barB$.
    Thus $\barG \der \app{\barA \to \barB}{f}{\bart} : \barB$ which allows us
    to conclude.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere p : \Id{T}{t}{t'}
        }{\Gamma \dere t \equiv t' : T}
    \end{mathc}
    \meta{Shouldn't we add as a premise that $T$ is an hSet?}
    By IH we deduce a translation of $\Gamma$ and now assume we have some such
    $\barG$. Now assume we aslo have $\barT$ a translation of $T$.
    \meta{How to proceed without translations of $t$ and $t'$?}

    \nextcase
    \begin{mathc}
      \ru{\Gamma, x:U \der t:V \qquad
          \Gamma \der u : U
        }{\Gamma \der
          \app{x:U.V}{(\lambda (x:U.V).t)}{u} \equiv t[u/x] : V[u/x]}
    \end{mathc}
    \meta{TODO}
  \end{caselist}
\end{proof}

\newpage
\hrulefill
OLD STUFF BELOW

Should the theorem be like:

\begin{theorem}
  If $\Gamma \dere t : T$, then there exists
  $\der \barG \in \den{\dere \Gamma}$ and for any such $\barG$ there exists
  $\barT$ such that $\barG \der \barT\ \type \in \den{\Gamma \dere T}$
  and for any such $\barT$ there exists $\bart$ such that
  $\barG \der \bart : \barT \in \den{\Gamma \dere t : T}$.
\end{theorem}
%
Where we have yet to define the translations sets $\den{\_}$.
We also have to tell explicitely how the theorem works on other judgments.
\meta{Also, we could use the bidirectionality for something...}

\begin{proof}
  By induction on the derivation.
  \begin{caselist}
    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere A\ \type \qquad
          \Gamma, x:A \dere B\ \type
        }{\Gamma \dere \Pi x:A.B\ \type}
    \end{mathc}
    \meta{Assuming} context extension and translation commute, it works.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere T\ \type \qquad
          \Gamma \dere t,t' \checks T
        }{\Gamma \dere \Id{T}{t}{t'}\ \type}
    \end{mathc}
    Same here.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere \Pi x:A.B\ \type \qquad
          \Gamma, x:A \dere t \checks B
        }{\Gamma \dere \lambda (x:A.B).t \infers \Pi x:A.B}
    \end{mathc}
    By first induction hypothesis, we have $\der \barG \in \den{\dere \Gamma}$.
    Now given such $\barG$, using the same induction hypothesis we have
    $\barG \der \Pi x:\barA.\barB\ \type
    \in \den{\Gamma \dere \Pi x:A.B\ \type}$
    (\meta{assuming} translation of types preserves shapes).
    Now given such $\Pi x:\barA.\barB$, we in particular have
    $\barG \der \barA\ \type \in \den{\Gamma \dere A\ \type}$
    (\meta{assuming} we have some kind of inversion linked with the previous
    assumption). The same goes for $\barB$.

    Now, we have $\der \barG, x:\barA \in \den{\dere \Gamma, x:A}$.
    Thus by second induction hypothesis with our choice of $\barA$ and
    $\barB$, we have $\bart$ such that
    $\barG, x:\barA \der \bart \checks \barB \in
    \den{\Gamma, x:A \dere t \checks B}$.
    Thus $\barG \der \lambda (x:\barA.\barB).\bart \infers \Pi x:\barA.\barB
    \in \den{\Gamma \dere \lambda (x:A.B).t \infers \Pi x:A.B}$.

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \checks \Pi x:A.B \qquad
          \Gamma \dere u \checks A
        }{\Gamma \dere \app{x:A.B}{t}{u} \infers B[u/x]}
    \end{mathc}
    \meta{What liberty do we have in providing a translation of $B[u/x]$? The
    ideal would that it has to be of the form $\barB[\baru/x]$.}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \checks T
        }{\Gamma \dere \refl_t \infers \Id{T}{t}{t}}
    \end{mathc}
    It seems to work under the same \meta{assumptions} as before (commutation
    between context extension and translation ; inversion of translation of
    types).

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t \infers A \qquad
          \Gamma \dere B\ \type \qquad
          \Gamma \dere A \equiv B
        }{\Gamma \dere t \checks B}
    \end{mathc}
    \meta{We need to know how to translate equalities to conclude...}
    \meta{Assuming it gives us an equivalence (provided the context and the two
    involved types) we can conclude.}

    \nextcase
    \begin{mathc}
      \ru{\Gamma, x:U \dere t:V \qquad
          \Gamma \dere u : U
        }{\Gamma \dere \app{x:U.V}{(\lambda (x:U.V).t)}{u} \equiv
          t[u/x] : V[u/x]}
    \end{mathc}
    \meta{The same problem with translations of $V[u/x]$.}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere t : \Pi x:U.V
        }{\Gamma \dere t \equiv \lambda (x:U.V).\app{x:U.V}{t}{x} : \Pi x:U.V}
    \end{mathc}
    \meta{TODO}

    \nextcase
    \begin{mathc}
      \ru{\Gamma \dere p : \Id{T}{t}{t'}
        }{\Gamma \dere t \equiv t' : T}
    \end{mathc}
    We get exactly what we want from the induction hypothesis (\meta{assuming}
    that for terms we require a proof term of equality).
  \end{caselist}
\end{proof}

\meta{Just an idea like that: Why not translating to OTT instead of ITT? This
way, it might reveal clearer what is an irrelevant equality since they would
compute more...}

\end{document}
