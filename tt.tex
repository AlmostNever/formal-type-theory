\section{Type theory}
\label{sec:type-theory}

In this section we give the formulation of type theory that we shall work with.

\subsection{Syntax}
\label{sec:syntax}

\begin{align*}
  \text{Context $\G$, $\D$}
    \bnf   {}& \ctxempty                && \text{empty context} \\
    \bnfor {}& \ctxextend{\G}{\A}       && \text{context $\G$ extended with $\A$} \\
  \\
  \text{Type $\A$, $\B$, $\C$}
    \bnf   {}& \Prod{\A} \B             && \text{product}\\
    \bnfor {}& \Id{\A}{\uu}{\vv}        && \text{identity type} \\
    \bnfor {}& \subst{\A}{\sbs}         && \text{substitution $\sbs$ applied to $\A$} \\
  \\
  \text{Term $\uu$, $\vv$, $\ww$}
    \bnf   {}& \var{k}                  && \text{the $k$-th variable index (a la de Bruijn)} \\
    \bnfor {}& \lam{\A}{\B} \uu         && \text{$\lambda$-abstraction} \\
    \bnfor {}& \app{\uu}{\A}{\B}{\vv}   && \text{application} \\
    \bnfor {}& \refl{\A} \uu            && \text{reflexivity} \\
    \bnfor {}& \subst{\uu}{\sbs}        && \text{substitution $\sbs$ applied to $\uu$} \\
  \\
  \text{Substitution $\sbs$, $\sbt$}
    \bnf   {}& \sbid{\G}                && \text{identity substitution $\G \to \G$} \\
    \bnfor {}& \sbcomp{\sbs}{\sbt}      && \text{composition of substitutions} \\
    \bnfor {}& \sbextend{\sbs}{\A}{\uu} && \text{substitution $\sbs$ extended with $\uu$ of type $\subst{\A}{\sbs}$} \\
    \bnfor {}& \sbweak{\G}{\A}          && \text{weakening substitution $\ctxextend{\G}{\A} \to \G$}
\end{align*}

\subsection{Judgments}
\label{sec:judgments}

\begin{align*}
& \isctx{\G}                    && \text{$\G$ is a context} \\
& \issubst{\sbs}{\G}{\D}        && \text{$\sbs$ is a substitution from context $\G$ to context $\D$} \\
& \istype{\G}{\A}               && \text{$\A$ is a type in context $\G$} \\
& \isterm{\G}{\uu}{\A}          && \text{$\uu$ is a term of type $\A$ in context $\G$} \\
& \eqctx{\G}{\D}                && \text{$\G$ and $\D$ are equal contexts} \\
& \eqtype{\G}{\A}{\B}           && \text{$\A$ and $\B$ are equal types in context $\G$} \\
& \eqterm{\G}{\uu}{\vv}{\A}     && \text{$\uu$ and $\vv$ are equal terms of type $\A$ in context $\G$}
\end{align*}

\subsection{Contexts \fbox{$\isctx{\G}$}}
\label{sec:contexts}

\begin{mathpar}
  \infer[\rl{ctx-empty}]
  { }
  {\isctx{\ctxempty}}

  \infer[\rl{ctx-extend}]
  {\istype{\G}{\A}
  }
  {\isctx{(\ctxextend{\G}{\A})}}
\end{mathpar}

\subsection{Substitutions \fbox{$\issubst{\sbs}{\G}{\D}$}}
\label{sec:subst}

\begin{mathpar}
  \infer[\rl{subst-id}]
  {\isctx{\G}}
  {\issubst{\sbid{\G}}{\G}{\G}}

  \infer[\rl{subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E}
  }
  {\issubst{\sbcomp{\sbt}{\sbs}}{\G}{\E}}

  \infer[\rl{subst-extend}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\G}{\uu}{\subst{\A}{\sbs}}
  }
  {\issubst
     {(\sbextend{\sbs}{\A}{\uu})}
     {\G}
     {(\ctxextend{\D}{\A})}
  }

  \infer[\rl{subst-weak}]
  {\istype{\G}{\A}}
  {\issubst
     {\sbweak{\G}{\A}}
     {\ctxextend{\G}{\A}}
     {\G}
  }
\end{mathpar}

We let $\sbshift{\sbs}{\G}{\A}$ stand for
$\sbextend{\sbcomp{\sbs}{\sbweak{\G}{\subst{\A}{\sbs}}}}{\A}{\var{0}}$.
Then we have the derivable rule
%
\begin{equation*}
  \infer
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A}
  }
  {\issubst
      {(\sbshift{\sbs}{\G}{\A})}
      {\ctxextend{\G}{\subst{\A}{\sbs}}}
      {\ctxextend{\D}{\A}}
  }
\end{equation*}

\subsection{Types \fbox{$\istype{\G}{\A}$}}

\subsubsection*{General rules}

\begin{mathpar}
  \infer[\rl{ty-ctx-conv}]
  {\istype{\G}{\A} \\
    \eqctx{\G}{\D}
  }
  {\istype{\D}{\A}}

  \infer[\rl{ty-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A}
  }
  {\istype{\G}{\subst{\A}{\sbs}}}
\end{mathpar}

\subsubsection*{Type formers}

\begin{mathpar}
  \infer[\rl{ty-prod}]
  {\istype{\G}{\A} \\
   \istype{\ctxextend{\G}{\A}}{\B}
  }
  {\istype{\G}{\Prod{\A}{\B}}}

  \infer[\rl{ty-id}]
  {\istype{\G}{\A}\\
   \isterm{\G}{\uu}{\A}\\
   \isterm{\G}{\vv}{\A}
  }
  {\istype{\G}{\Id{\A}{\uu}{\vv}}}
\end{mathpar}

\subsection{Terms \fbox{$\isterm{\G}{\uu}{\A}$}}

\subsubsection*{General rules}
\begin{mathpar}
  \infer[\rl{term-ty-conv}]
  {\isterm{\G}{\uu}{\A} \\
   \eqtype{\G}{\A}{\B}
  }
  {\isterm{\G}{\uu}{\B}}

  \infer[\rl{term-ctx-conv}]
  {\isterm{\G}{\uu}{\A} \\
   \eqctx{\G}{\D}
  }
  {\isterm{\D}{\uu}{\A}}

  \infer[\rl{term-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\uu}{\A}
  }
  {\isterm{\G}{\subst{\uu}{\sbs}}{\subst{\A}{\sbs}}}
\end{mathpar}

\subsubsection*{Variables}

\begin{mathpar}
  \infer[\rl{term-var}]
  {
   \istype{\G}{\A}
  }
  {\isterm
     {\ctxextend{\G}{\A}}
     {\var{0}}
     {\subst{\A}{\sbweak{\G}{\A}}}
  }

  \infer[\rl{term-var-skip}]
  {\isterm{\G}{\var{k}}{\A} \\
   \istype{\G}{\B}
  }
  {\isterm
     {\ctxextend{\G}{\B}}
     {\var{k+1}}
     {\subst{\A}{\sbweak{\G}{\B}}}
  }
  \end{mathpar}

\subsubsection*{Abstraction and application}

\begin{mathpar}
  % Remark: we want \istype{\G}{\A} as a premise because in order to form the
  % product type we need it, and we do not want to resort to inversion on the
  % extended context.
  \infer[\rl{term-abs}]
  { \istype{\G}{\A} \\
    \isterm{\ctxextend{\G}{\A}}{\uu}{\B}
  }
  {\isterm{\G}{(\lam{\A}{\B}{\uu})}{\Prod{\A}{\B}}}

  % Remark: we want \istype{\ctxextend{\G}{\A}}{\B} because we need to
  % know that \B is a type in \ctxextend{\G}{\A} and we want to avoid
  % inversion on ty-prod.
  \infer[\rl{term-app}]
  {\istype{\ctxextend{\G}{\A}}{\B} \\
   \isterm{\G}{\uu}{\Prod{\A} \B} \\
   \isterm{\G}{\vv}{\A}
  }
  {\isterm
     {\G}
     {\app{\uu}{\A}{\B}{\vv}}
     {\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}}}
  }
\end{mathpar}


\subsubsection*{Reflexivity}

\begin{mathpar}
  \infer[\rl{term-refl}]
  {\isterm{\G}{\uu}{\A}}
  {\isterm{\G}{\refl{\A} \uu}{\Id{\A}{\uu}{\uu}}}
\end{mathpar}

\subsection{Context equality \fbox{$\eqctx{\G}{\D}$}}
\label{sec:cont-equal}

\begin{mathpar}
  \infer[\rl{eq-ctx-empty}]
  { }
  {\eqctx{\ctxempty}{\ctxempty}}

  \infer[\rl{eq-ctx-extend}]
  {\eqctx{\G}{\D} \\
   \eqtype{\G}{\A}{\B}
  }
  {\eqctx{(\ctxextend{\G}{\A})}{(\ctxextend{\D}{\B})}}

  \infer[\rl{eq-ctx-refl}]
  {\isctx{\G}}
  {\eqctx{\G}{\G}}

  \infer[\rl{eq-ctx-sym}]
  {\eqctx{\D}{\G}}
  {\eqctx{\G}{\D}}

  \infer[\rl{eq-ctx-trans}]
  {\eqctx{\G}{\D} \\
   \eqctx{\D}{\E}}
  {\eqctx{\G}{\E}}
\end{mathpar}

\goodbreak

\subsection{Type equality \fbox{$\eqtype{\G}{\A}{\B}$}}
\label{sec:type-equality}

\subsubsection*{General rules}

\begin{mathpar}
  \infer[\rl{eq-ty-conv}]
  {\eqtype{\G}{\A}{\B}\\
    \eqctx{\G}{\D}}
  {\eqtype{\D}{\A}{\B}}

  \infer[\rl{eq-ty-refl}]
  {\istype{\G}{\A}}
  {\eqtype{\G}{\A}{\A}}

  \infer[\rl{eq-ty-sym}]
  {\eqtype{\G}{\B}{\A}}
  {\eqtype{\G}{\A}{\B}}

  \infer[\rl{eq-ty-trans}]
  {\eqtype{\G}{\A}{\B}\\
   \eqtype{\G}{\B}{\C}}
  {\eqtype{\G}{\A}{\C}}
\end{mathpar}

\subsubsection*{Substitution}

\begin{mathpar}
  \infer[\rl{eq-ty-subst-id}]
  {\istype{\G}{\A}}
  {\eqtype{\G}
     {\subst{\A}{\sbid{\G}}}
     {\A}
  }

  \infer[\rl{eq-ty-subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E} \\
   \istype{\E}{\A}
  }
  {\eqtype{\G}
    {\subst{\A}{\sbcomp{\sbs}{\sbt}}}
    {\subst{(\subst{\A}{\sbs})}{\sbt}}
  }

  \infer[\rl{eq-ty-subst-prod}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \istype{\ctxextend{\D}{\A}}{\B}
  }
  {\eqtype{\G}
   {\subst{(\Prod{\A}{\B})}{\sbs}}
   {\Prod
     {\subst{\A}{\sbs}}
     {\subst{\B}{\sbshift{\sbs}{\G}{\A}}}
   }
  }

  \infer[\rl{eq-ty-subst-id}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\D}{\uu}{\A} \\
   \isterm{\D}{\vv}{\A}
  }
  {\eqtype{\G}
   {\subst{(\Id{\A}{\uu}{\vv})}{\sbs}}
   {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\vv}{\sbs}}}
  }
\end{mathpar}

\subsubsection*{Congruence rules}

\begin{mathpar}
  \infer[\rl{cong-prod}]
  {\eqtype{\G}{\A_1}{\B_1}\\
   \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}}
  {\eqtype{\G}{\Prod{\A_1}{\A_2}}{\Prod{\B_1}{\B_2}}}

  \infer[\rl{cong-id}]
  {\eqtype{\G}{\A}{\B}\\
   \eqterm{\G}{\uu_1}{\vv_1}{\A}\\
   \eqterm{\G}{\uu_2}{\vv_2}{\A}
  }
  {\eqtype{\G}{\Id{\A}{\uu_1}{\uu_2}}
              {\Id{\B}{\vv_1}{\vv_2}}}

  \infer[\rl{cong-ty-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \eqtype{\D}{\A}{\B}
  }
  {\eqtype{\G}{\subst{\A}{\sbs}}{\subst{\B}{\sbs}}}
\end{mathpar}

\goodbreak

\subsection{Term equality \fbox{$\eqterm{\G}{\uu_1}{\uu_2}{\A}$}}

\subsubsection*{General rules}

\begin{mathpar}
  \infer[\rl{eq-ty-conv}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
    \eqtype{\G}{\A}{\B}}
  {\eqterm{\G}{\uu}{\vv}{\B}}

  \infer[\rl{eq-ctx-conv}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
    \eqctx{\G}{\D}}
  {\eqterm{\D}{\uu}{\vv}{\A}}

  \infer[\rl{eq-refl}]
  {\isterm{\G}{\uu}{\A}}
  {\eqterm{\G}{\uu}{\uu}{\A}}

  \infer[\rl{eq-sym}]
  {\eqterm{\G}{\vv}{\uu}{\A}}
  {\eqterm{\G}{\uu}{\vv}{\A}}

  \infer[\rl{eq-trans}]
  {\eqterm{\G}{\uu}{\vv}{\A}\\
   \eqterm{\G}{\vv}{\ww}{\A}}
  {\eqterm{\G}{\uu}{\ww}{\A}}
\end{mathpar}

\subsubsection*{Substitutions}

\begin{mathpar}
  \infer[\rl{eq-subst-id}]
  {\isterm{\G}{\uu}{\A}}
  {\eqterm{\G}
     {\subst{\uu}{\sbid{\G}}}
     {\uu}
     {\A}
  }

  \infer[\rl{eq-subst-compose}]
  {\issubst{\sbs}{\G}{\D} \\
   \issubst{\sbt}{\D}{\E} \\
   \isterm{\E}{\uu}{\A}
  }
  {\eqterm{\G}
    {\subst{\uu}{\sbcomp{\sbs}{\sbt}}}
    {\subst{(\subst{\uu}{\sbs})}{\sbt}}
    {\subst{\A}{\sbcomp{\sbs}{\sbt}}}
  }

  \infer[\rl{eq-subst-weak}]
  {\isterm{\G}{\var{k}}{\A} \\
   \istype{\G}{\B}
  }
  {\eqterm{\ctxextend{\G}{\B}}
   {\subst{\var{k}}{\sbweak{\G}{\B}}}
   {\var{k+1}}
   {\subst{\A}{\sbweak{\G}{\B}}}
  }

  \infer[\rl{eq-subst-extend-zero}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\G}{\uu}{\subst{\A}{\sbs}}
  }
  {\eqterm{\G}
     {\subst{\var{0}}{\sbextend{\sbs}{\A}{\uu}}}
     {\uu}
     {\subst{\A}{\sbs}}
  }

  \infer[\rl{eq-subst-extend-succ}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\var{k}}{\A} \\
   \isterm{\G}{\uu}{\subst{\B}{\sbs}}
  }
  {\eqterm{\G}
     {\subst
        {\var{k+1}}
        {\sbextend{\sbs}{\B}{\uu}}
     }
     {\subst{\var{k}}{\sbs}}
     {\subst{\A}{\sbs}}
  }

  \infer[\rl{eq-subst-abs}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\ctxextend{\D}{\A}}{\uu}{\B}
  }
  {\eqterm{\G}
    {\subst{(\lam{\A}{\B} \uu)}{\sbs}}
    {(\lam
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
      \subst{\uu}{\sbextend{\sbs}{\A}{\var{0}}})
    }
    {\Prod
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
    }
  }

  \infer[\rl{eq-subst-app}]
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\ctxextend{\D}{\A}}{\B} \\
   \isterm{\D}{\uu}{\Prod{\A}{\B}} \\
   \isterm{\D}{\vv}{\A}
  }
  {\eqterm{\G}
   {\subst{(\app{\uu}{\A}{\B}{\vv})}{\sbs}}
   {\app
      {\subst{\uu}{\sbs}}
      {\subst{\A}{\sbs}}
      {\subst
        {\B}
        {\sbshift{\sbs}{\G}{\subst{\A}{\sbs}}}
      }
      {\subst{\vv}{\sbs}}}
   {\subst
     {(\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}})}
     {\sbs}
   }
  }

  \infer[\rl{eq-subst-refl}]
  {\issubst{\sbs}{\G}{\D} \\
   \isterm{\D}{\uu}{\A}
  }
  {\eqterm{\G}
   {\subst{(\refl{\A}{\uu})}{\sbs}}
   {\refl{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}}
   {\Id{\subst{\A}{\sbs}}{\subst{\uu}{\sbs}}{\subst{\uu}{\sbs}}}
  }
\end{mathpar}

\subsubsection*{Equality reflection}
%
\begin{mathpar}
  \infer[\rl{eq-reflection}]
  {\isterm{\G}{\ww_1}{\Id{\A}{\uu}{\vv}} \\
   \isterm{\G}{\ww_2}{\textsf{UIP}(\A)}
  }
  {\eqterm{\G}{\uu}{\vv}{\A}}
\end{mathpar}
%
Here $\mathsf{UIP}(\A)$ is an abbreviation for what is written traditionally as
``all parallel paths in $\A$ are (propositionally) equal''.

\subsubsection*{Computation and Extensionality}

\begin{mathpar}
\infer[\rl{prod-beta}]
  {\isterm{\ctxextend{\G}{\A}}{\uu}{\B}\\
    \isterm{\G}{\vv}{\A}}
  {\eqterm{\G}{\bigl(\app{(\lam{\A}{\B}{\uu})}{\A}{\B}{\vv}\bigr)}
              {\subst{\uu}{\sbextend{\sbid{\G}}{\A}{\vv}}}
              {\subst{\B}{\sbextend{\sbid{\G}}{\A}{\vv}}}}

  % \infer[\rl{uip}]
  % {\isterm{\G}{\vv_1}{\Id{\A}{\uu}{\vv}} \\
  %   \isterm{\G}{\vv_2}{\Id{\A}{\uu}{\vv}}
  % }
  % {\eqterm{\G}{\vv_1}{e'_2}{\Id{\A}{\uu}{\vv}}}

  \infer[\rl{prod-eta}]
  {\isterm{\G}{\uu}{\Prod{\A}{\B}}\\
   \isterm{\G}{\vv}{\Prod{\A}{\B}}\\\\
   \eqterm
      {\ctxextend{\G}{\A}}
      {(\app
          {\subst{\uu}{\sbweak{\G}{\A}}}
          {\subst{\A}{\sbweak{\G}{\A}}}
          {\subst
            {\B}
            {\sbshift
              {\sbweak{\G}{\A}}
              {\ctxextend{\G}{\A}}
              {\A}
            }
          }
          {\var{0}})
      }
      {(\app
          {\subst{\vv}{\sbweak{\G}{\A}}}
          {\subst{\A}{\sbweak{\G}{\A}}}
          {\subst
            {\B}
            {\sbshift
              {\sbweak{\G}{\A}}
              {\ctxextend{\G}{\A}}
              {\A}
            }
          }
          {\var{0}})
      }
      {\B}
  }
  {\eqterm{\G}{\uu}{\vv}{\Prod{\A}{\B}}}
\end{mathpar}

The rule $\rl{prod-eta}$ is optional. We may prefer not to keep it around, as it amounts
to function extensionality.

\subsubsection*{Congruence rules}

\begin{mathpar}

  \infer[\rl{cong-abs}]
  {\eqtype{\G}{\A_1}{\B_1}\\
    \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}\\
    \eqterm{\ctxextend{\G}{\A_1}}{\uu_1}{\uu_2}{\A_2}}
  {\eqterm{\G}{(\lam{\A_1}{\A_2}{\uu_1})}
              {(\lam{\B_1}{\B_2}{\uu_2})}
              {\Prod{\A_1}{\A_2}}}

  \infer[\rl{cong-app}]
  {\eqtype{\G}{\A_1}{\B_1}\\
   \eqtype{\ctxextend{\G}{\A_1}}{\A_2}{\B_2}\\\\
   \eqterm{\G}{\uu_1}{\vv_1}{\Prod{\A_1}{\A_2}}\\
   \eqterm{\G}{\uu_2}{\vv_2}{\A_1}}
  {\eqterm
    {\G}
    {(\app{\uu_1}{\A_1}{\A_2}{\uu_2})}
    {(\app{\vv_1}{\B_1}{\B_2}{\vv_2})}
    {\subst{\A_2}{\sbextend{\sbid{\G}}{\A_1}{\uu_2}}}
  }

  \infer[\rl{cong-refl}]
  {\eqterm{\G}{\uu_1}{\uu_2}{\A_1}\\
    \eqtype{\G}{\A_1}{\A_2}}
  {\eqterm{\G}{\refl{\A_1} \uu_1}{\refl{\A_2} \uu_2}{\Id{\A_1}{\uu_1}{\uu_1}}}


  \infer[\rl{cong-term-subst}]
  {\issubst{\sbs}{\G}{\D} \\
   \eqterm{\D}{\uu_1}{\uu_2}{\A}
  }
  {\eqterm{\G}{\subst{\uu_1}{\sbs}}{\subst{\uu_2}{\sbs}}{\subst{\A}{\sbs}}}

\end{mathpar}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
