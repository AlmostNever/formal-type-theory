\subsection{J eliminator}
\label{sec:j-elim}

\begin{align*}
  \text{Term $\uu$, $\vv$, $\ww$}
    \bnf   {}& \ldots                        && \text{previous terms} \\
    \bnfor {}& \J{\A}{\uu}{\C}{\ww}{\vv}{\p} && \text{the J eliminator}
\end{align*}

\newcommand{\rlTermJ}{\referTo{term-j}{rul:term-j}}
\newcommand{\showTermJ}{%
  \infer[\rulename{term-j}] % TermJ
  {\istype{\G}{\A} \\
   \isterm{\G}{\uu}{\A} \\
   \istype
    {\ctxextend
      {\ctxextend{\G}{\A}}
      {\Id
        {\subst{\A}{\sbweak{\G}{\A}}}
        {\subst{\uu}{\sbweak{\G}{\A}}}
        {\var{0}}}
    }
    {\C} \\
   \isterm
    {\G}
    {\ww}
    {\subst
      {\subst
        {\C}
        {\sbshift
          {\G}
          {\Id
            {\subst{\A}{\sbweak{\G}{\A}}}
            {\subst{\uu}{\sbweak{\G}{\A}}}
            {\var{0}}
          }
          {\sbzero{\G}{\A}{\uu}}
        }
      }
      {\sbzero{\G}{\Id{\A}{\uu}{\uu}}{\refl{\A} \uu}}
    } \\
   \isterm{\G}{\vv}{\A} \\
   \isterm{\G}{\p}{\Id{\A}{\uu}{\vv}}
  }
  {\isterm{\G}
    {\J{\A}{\uu}{\C}{\ww}{\vv}{\p}}
    {\subst
      {\subst
        {\C}
        {\sbshift
          {\G}
          {\Id
            {\subst{\A}{\sbweak{\G}{\A}}}
            {\subst{\uu}{\sbweak{\G}{\A}}}
            {\var{0}}
          }
          {\sbzero{\G}{\A}{\vv}}
        }
      }
      {\sbzero{\G}{\Id{\A}{\uu}{\vv}}{\p}}
    }
  }
}

\newcommand{\rlEqSubstJ}{\referTo{eq-subst-j}{rul:eq-subst-j}}
\newcommand{\showEqSubstJ}{%
  \infer[\rulename{eq-subst-j}] % EqSubstJ
  {\issubst{\sbs}{\G}{\D} \\
   \istype{\D}{\A} \\
   \isterm{\D}{\uu}{\A} \\
   \istype
    {\ctxextend
      {\ctxextend{\D}{\A}}
      {\Id
        {\subst{\A}{\sbweak{\D}{\A}}}
        {\subst{\uu}{\sbweak{\D}{\A}}}
        {\var{0}}}
    }
    {\C} \\
   \isterm
    {\D}
    {\ww}
    {\subst
      {\subst
        {\C}
        {\sbshift
          {\D}
          {\Id
            {\subst{\A}{\sbweak{\D}{\A}}}
            {\subst{\uu}{\sbweak{\D}{\A}}}
            {\var{0}}
          }
          {\sbzero{\D}{\A}{\uu}}
        }
      }
      {\sbzero{\D}{\Id{\A}{\uu}{\uu}}{\refl{\A} \uu}}
    } \\
   \isterm{\D}{\vv}{\A} \\
   \isterm{\D}{\p}{\Id{\A}{\uu}{\vv}}
  }
  {\eqterm{\G}
    {\subst
      {\J{\A}{\uu}{\C}{\ww}{\vv}{\p}}
      {\sbs}
    }
    {\J
      {\subst{\A}{\sbs}}
      {\subst{\uu}{\sbs}}
      {\subst{\C}{\sbt}}
      {\subst{\ww}{\sbs}}
      {\subst{\vv}{\sbs}}
      {\subst{\p}{\sbs}}
    }
    {\subst
      {\subst
        {\subst
          {\C}
          {\sbr}
        }
        {\sbzero{\G}{\Id{\A}{\uu}{\vv}}{\p}}
      }
      {\sbs}
    }
  }

  \text{Where } \sbt =
    \sbshift
      {\ctxextend{\G}{\subst{\A}{\sbs}}}
      {\Id
        {\subst{\A}{\sbweak{\D}{\A}}}
        {\subst{\uu}{\sbweak{\D}{\A}}}
        {\var{0}}
      }
      {(\sbshift{\G}{\A}{\sbs})}

  \text{and } \sbr =
    \sbshift
      {\G}
      {\Id
        {\subst{\A}{\sbweak{\G}{\A}}}
        {\subst{\uu}{\sbweak{\G}{\A}}}
        {\var{0}}
      }
      {\sbzero{\G}{\A}{\vv}}
}

\newcommand{\rlCongJ}{\referTo{cong-j}{rul:cong-j}}
\newcommand{\showCongJ}{%
  \infer[\rulename{cong-j}] % CongJ
  {\eqtype{\G}{\A_1}{\A_2} \\
   \eqterm{\G}{\uu_1}{\uu_2}{\A_1} \\
   \eqtype
    {\ctxextend
      {\ctxextend{\G}{\A}}
      {\Id
        {\subst{\A}{\sbweak{\G}{\A}}}
        {\subst{\uu}{\sbweak{\G}{\A}}}
        {\var{0}}}
    }
    {\C_1}
    {\C_2} \\
   \eqterm
    {\G}
    {\ww_1}
    {\ww_2}
    {\subst
      {\subst
        {\C_1}
        {\sbshift
          {\G}
          {\Id
            {\subst{\A_1}{\sbweak{\G}{\A_1}}}
            {\subst{\uu_1}{\sbweak{\G}{\A_1}}}
            {\var{0}}
          }
          {\sbzero{\G}{\A_1}{\uu_1}}
        }
      }
      {\sbzero{\G}{\Id{\A_1}{\uu_1}{\uu_1}}{\refl{\A_1} \uu_1}}
    } \\
   \eqterm{\G}{\vv_1}{\vv_2}{\A_1} \\
   \eqterm{\G}{\p_1}{\p_2}{\Id{\A_1}{\uu_1}{\vv_1}}
  }
  {\eqterm{\G}
    {\J{\A_1}{\uu_1}{\C_1}{\ww_1}{\vv_1}{\p_1}}
    {\J{\A_2}{\uu_2}{\C_2}{\ww_2}{\vv_2}{\p_2}}
    {\subst
      {\subst
        {\C_1}
        {\sbr}
      }
      {\sbzero{\G}{\Id{\A_1}{\uu_1}{\vv_1}}{\p_1}}
    }
  }

  \text{Where } \sbr =
    \sbshift
      {\G}
      {\Id
        {\subst{\A_1}{\sbweak{\G}{\A_1}}}
        {\subst{\uu_1}{\sbweak{\G}{\A_1}}}
        {\var{0}}
      }
      {\sbzero{\G}{\A_1}{\vv_1}}
}

\newcommand{\rlJRefl}{\referTo{j-refl}{rul:j-refl}}
\newcommand{\showJRefl}{%
  \infer[\rulename{j-refl}] % JRefl
  {\istype{\G}{\A} \\
   \isterm{\G}{\uu}{\A} \\
   \istype
    {\ctxextend
      {\ctxextend{\G}{\A}}
      {\Id
        {\subst{\A}{\sbweak{\G}{\A}}}
        {\subst{\uu}{\sbweak{\G}{\A}}}
        {\var{0}}}
    }
    {\C} \\
   \isterm
    {\G}
    {\ww}
    {\subst
      {\subst
        {\C}
        {\sbt}
      }
      {\sbzero{\G}{\Id{\A}{\uu}{\uu}}{\refl{\A} \uu}}
    }
  }
  {\eqterm{\G}
    {\J{\A}{\uu}{\C}{\ww}{\uu}{\refl{\A} \uu}}
    {\ww}
    {\subst
      {\subst
        {\C}
        {\sbt}
      }
      {\sbzero{\G}{\Id{\A}{\uu}{\uu}}{\refl{\A} \uu}}
    }
  }

  \text{Where } \sbt =
    \sbshift
      {\G}
      {\Id
        {\subst{\A}{\sbweak{\G}{\A}}}
        {\subst{\uu}{\sbweak{\G}{\A}}}
        {\var{0}}
      }
      {\sbzero{\G}{\A}{\uu}}
}

\begin{mathpar}
  {\label{rul:term-j} \showTermJ}

  \label{rul:eq-subst-j} \showEqSubstJ

  \label{rul:cong-j} \showCongJ

  \label{rul:j-refl} \showJRefl
\end{mathpar}

Remark: Lemma~\ref{pbm:id-inversion} still holds with this extension.


\subsubsection*{Rule {\rlTermJ}}

Consider a derivation ending with
%
\begin{equation*}
  \showTermJ
\end{equation*}
%
By induction hypothesis we have $\isctx{\G}$.
%
By {\rlSubstZero} and one the assumptions we have
$\issubst{\sbzero{\G}{\A}{\vv}}{\G}{\ctxextend{\G}{\A}}$,
then, by {\rlSubstShift}, remarking that we can derive
$\istype
  {\ctxextend{\G}{\A}}
  {\Id{\subst{\A}{\sbweak{\G}{\A}}}{\subst{\uu}{\sbweak{\G}{\A}}}{\var{0}}}
$ \meta{(why?)},
we have
$\issubst
  {\sbshift
    {\G}
    {\Id{\subst{\A}{\sbweak{\G}{\A}}}{\subst{\uu}{\sbweak{\G}{\A}}}{\var{0}}}
    {\sbzero{\G}{\A}{\vv}}
  }
  {\D_1}
  {\D_2}
$
where the contexts are defined as
$\D_1 =
\ctxextend
  {\G}
  {\subst
    {(\Id
      {\subst{\A}{\sbweak{\G}{\A}}}
      {\subst{\uu}{\sbweak{\G}{\A}}}
      {\var{0}}
    )}
    {\sbzero{\G}{\A}{\vv}}
  }
$ as well as
$\D_2 =
\ctxextend
  {\ctxextend{\G}{\A}}
  {\Id
    {\subst{\A}{\sbweak{\G}{\A}}}
    {\subst{\uu}{\sbweak{\G}{\A}}}
    {\var{0}}
  }
$.
From this and {\rlTySubst} we derive
$\istype
  {\D_1}
  {\subst
    {\C}
    {\sbshift
      {\G}
      {\Id{\subst{\A}{\sbweak{\G}{\A}}}{\subst{\uu}{\sbweak{\G}{\A}}}{\var{0}}}
      {\sbzero{\G}{\A}{\vv}}
    }
  }
$.
Now using {\rlEqTySubstId}, {\rlCongId} as well as {\rlEqTyWeakZero},
{\rlEqSubstZeroZero}
and \meta{a rule that is missing on weakening and subst zero on terms} prior
to {\rlEqCtxExtend} and then {\rlTyCtxConv} we get
$\istype
  {\ctxextend
    {\G}
    {\Id{\A}{\uu}{\vv}}
  }
  {\subst
    {\C}
    {\sbshift
      {\G}
      {\Id{\subst{\A}{\sbweak{\G}{\A}}}{\subst{\uu}{\sbweak{\G}{\A}}}{\var{0}}}
      {\sbzero{\G}{\A}{\vv}}
    }
  }
$.
Then, from {\rlSubstZero} again we get
$\issubst
  {\sbzero{\G}{\Id{\A}{\uu}{\vv}}{\p}}
  {\G}
  {\ctxextend{\G}{\Id{\A}{\uu}{\vv}}}
$, allowing to conclude by {\rlTySubst}:
$\istype
  {\G}
  {\subst
    {\subst
      {\C}
      {\sbshift
        {\G}
        {\Id{\subst{\A}{\sbweak{\G}{\A}}}{\subst{\uu}{\sbweak{\G}{\A}}}{\var{0}}}
        {\sbzero{\G}{\A}{\vv}}
      }
    }
    {\sbzero{\G}{\Id{\A}{\uu}{\vv}}{\p}}
  }
$.


\subsubsection*{Rule {\rlEqSubstJ}}

Consider a derivation ending with
%
\begin{mathpar}
  \showEqSubstJ
\end{mathpar}
%
By induction hypothesis we have $\isctx{\G}$.
\meta{TODO}


\subsubsection*{Rule {\rlCongJ}}

Consider a derivation ending with
%
\begin{mathpar}
  \showCongJ
\end{mathpar}
%
By induction hypothesis we have $\isctx{\G}$.
\meta{TODO}


\subsubsection*{Rule {\rlJRefl}}

Consider a derivation ending with
%
\begin{mathpar}
  \showJRefl
\end{mathpar}
%
By induction hypothesis we have $\isctx{\G}$.
\meta{TODO}
